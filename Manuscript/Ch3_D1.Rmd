---
title: Disturbed habitats cannot support diverse competitive interactions in Neotropical bats and birds.
author:
  - "Anikó B. Tóth"
  - "Andrew P. Allen"
  - "S. Kathleen Lyons"
  - "John Alroy"
output:
  bookdown::word_document2: default
bibliography: References.bib
csl: proceedings-b.csl

---

^1^ Centre for Ecosystem Science, School of Biological, Earth and Environmental Sciences, UNSW, Sydney, NSW 2052, Australia.

^2^ Department of Biological Sciences, Macquarie University, New South Wales 2109, Australia.

^3^ School of Biological Sciences, University of Nebraska-Lincoln, Lincoln, Nebraska 68588, USA.


__Abstract__

Anthropogenic habitat destruction is one of the greatest threats facing animal communities. To advance conservation and management initiatives, it is crucial to understand how habitat alteration changes the way communities assemble. Increasing evidence points to the role of biotic interactions in structuring communities even on large spatial scales, and human activities may disrupt these processes indirectly. However, we do not yet have widely applicable, robust methods for quantifying the effects of biotic interactions in biodiverse assemblages. Here, we present a bayesian model that detects and quantifies the role of diffuse competition in shaping large assemblages, specifically, whether or not it tends to result in exclusion. Using our approach, we examine the outcome of food competition in neotropical birds and bats, and compare the results for assemblages collected from human-altered and unaltered habitats. We document a tendency of food competition to aggregate bat and bird species in unaltered habitats. By contrast, altered habitats tend to segregate competing pairs with respect to opportunity. Our results point to a loss of ecosystem functionality--the ability to support diverse competitive interactions--which can be damaging if intraspecific competition provides ecosystem services such as the control of pest abundances. Habitat alteration therefore strongly affects community structure via changes in competitive outcomes, nullifying and often reversing patterns observed in the wild.


```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(igraph)
library(reshape2)
library(vegan)
library(sp)
library(stringi)
library(parallel)

knitr::opts_chunk$set(include = FALSE)

## Load helper functions
source('../Code/HelperFunctions.R')
## Prep raw data
source('../Code/Data_Prep.R')

# species metadata
#load("../Data/Species_metadata.RData")
#load("../Data/cosmo_species_cosmopolitan_score.RData") # cosmopolitan category 
# Site data #
#load("../Data/sitedat_metadata.Rdata")

## Richness results
load("../Results/cj1_chao_richness_raw.RData")

taxa = c("bat", "bird")

unalt_sites <- sitedat[sitedat$altered_habitat == "",]$siteid

```


### Main text: 

#### Introduction

How does human habitat alteration disrupt biological processes? With rapidly changing global conditions, this question is on the forefront of many urgent research agendas, spanning conservation, restoration, ecosystem management, environmental science, ecology, and paleoecology. It is increasingly recognised that the effects of human disturbance extend many thousands of years into the past [@Lyons2016; @Maezumi2018], across the entire planet [@Sanderson2002; @Ellis2008], and may continue to be felt tens of millions of years into the future [@Novacek2001; @Alroy2008]. 

Human impacts on the natual drivers of community assembly, such as climate change [@IPCC2007], habitat alteration [@Alroy2017], engineering of dispersal barriers [@Cui2018], and changes in interaction networks [@DeAssisBomfim2018], have been a focus of intense research interest. Aside from the straightforward introduction or removal of species, the last of these is probably the most poorly understood, with many researchers still working to understand the dynamics of interaction systems without even considering human impacts explicitly [@Baiser2019]. Nonetheless, there is evidence that human disturbance can decouple predator-prey interactions [@Rodewald2011], increase competition for pollinators [@Holzschuh2011], and simplify or break apart interaction networks [@Haddad2000; @DeAssisBomfim2018].

Though the subject has long been contentious among both ecologists [@McGill2010; @Araujo2013] and palaeontologists [@Ezard2016; @Marshall2016], evidence has long accumulated that the effects of biotic interactions scale up to measurably influence community assembly at much larger spatial scales [@Araujo2007; @Pollock2014; @Fraser2021 in press] than the scale of individual encounters would suggest. The same appears to be true for biotic processes occurring over geological timescales, as mounting evidence demonstrates that interactions such as competition and facilitation can be instrumental in structuring spatial patterns over thousands of years [@Toth2019], as well as the diversification and extinction of entire clades on timescales of millions of years [@Sepkoski1984; @Alroy2010]. Though many interaction networks have been documented in detail, these are usually limited to single locations or small extents, so the way in which this upscaling unfolds is still not well understood.

One obvious reason for the limited understanding of biotic interactions is that they are costly and challenging to monitor directly. Quantitative methods that are capable of distinguishing the effects of biotic interactions from other drivers are therefore becoming crucially important, and indeed have already begun to yield promising results [@Fraser2021 in press]. Such methods rely on large datasets of species occurrence and ecological traits that are becoming widely available and were therefore not feasible until very recently. The question of shifting biotic interactions is as critical as it is elusive. The degree to which biotic interactions have been disrupted is one of the five criteria proposed for assessing the risk level of ecosystems and has been adopted by the IUCN Red List of Ecosystems [@Keith2015]. Humans produce pollution, change the spatial allocation of resources, genetically modify organisms, and engineer novel ecological niches, demonstrating a vast potential to affect the dynamics of biotic interactions and thus the composition of assemblages living in proximity to human-altered areas, all without necessarily adding or removing species.

Herein, we present a Bayesian method that quantifies the effect of diffuse biotic interactions on large assemblages. Specifically, it identifies whether interacting species in large assemblages (e.g. those competing for food) tend to exhibit coexistence, exclusion, both, or neither. The model allows users to examine individual pairs or groups of pairs for their contributions to the overall pattern, thus moving toward a better understanding of how biotic interactions scale from individual interspecific interactions to landscape-scale spatial patterns. We demonstrate the model by applying it to assemblages of neotropical bats and birds and compare the outcome of diffuse food competition between altered and unaltered habitats. Our analysis sheds light on how human habitat disturbance influences spatial patterns by altering the course of competitive interactions across landscape-scale assemblages.


#### Materials and Methods

```{r, echo = FALSE}
unalt_sites <- sitedat %>% filter(status == "Unaltered") %>% pull(sample.no) 
```

Abundance data were dowloaded from the Ecological Register (http://ecoregister.org) on 7th June 2020 for mistnetted bats and birds from the Neotropics, defined as all areas in the western hemisphere south of the Tropic of Cancer (23.44˚N). We also dowloaded Register metadata for the species and sites in the abundance tables, including coordinates and habitat alteration category for sites and dietary guild assignments for species. Guild assignments were based on a large set of recently published individual papers. Sampling and reporting was standardised across the samples, as all were mist-netted samples with consistent mesh size, harp net samples were excluded, and almost all nets were placed at ground level. Every sample consisted of a minimum of 20 individuals and the vast majority of sites had more than 50, with the average number of individuals per sample being `r mean(colSums(PAn[["bat"]]))` for bats and `r mean(colSums(PAn[["bird"]]))` for birds.  Samples were combined if they were within the same 11.1 km equal-area grid cell, sourced from the same study, and represented the same habitat and alteration category. The combined data consisted of a total of `r sum(PAn[["bat"]])` bat and `r sum(PAn[['bird']])` bird individuals from `r ncol(PAn[['bat']])` and `r ncol(PAn[['bird']])` sites, respectively. Maps of the sites are plotted in Figure S1.


```{r, include = FALSE}
#### Change to presence-absence ####
PAn<- tobinary(PAn)
PAnu <- PAn %>% map(~return(.[,colnames(.) %in% unalt_sites])) # separate unaltered
PAna <- PAn %>% map(~return(.[,!colnames(.) %in% unalt_sites])) # and altered sites

#### Match Biogeography ####
meta <- sitedat %>% split(.$taxon)
coords <- map(meta, select, c(sample.no, latitude, longitude)) 

# Remove unaltered or altered sites that are not near a site of the other type. This is done to ensure the two sets have similar biogoegraphical distributions.
coords1 <- purrr::map2(coords, PAnu, function(x, y) x[x$sample.no %in% colnames(y),])
coords2 <- purrr::map2(coords, PAna, function(x, y) x[x$sample.no %in% colnames(y),])
keep <- map2(coords1, coords2, matchbiogeo) %>% map(unlist)

PAn <- map2(PAn, keep, function(x, y) return(x[,as.character(y)]))
PAn <- map(PAn, clean.empty, minrow = 1) # remove any species that now have no occurrences

# recalculate alt/unalt split from new PAn
PAnu <- PAn %>% map(~return(.[,colnames(.) %in% unalt_sites]))
PAna <- PAn %>% map(~return(.[,!colnames(.) %in% unalt_sites]))

# coords of sites we kept, for plotting later.
coords1.keep <- purrr::map2(coords, PAnu, function(x, y) x[x$sample.no %in% colnames(y),])
coords2.keep <- purrr::map2(coords, PAna, function(x, y) x[x$sample.no %in% colnames(y),])

```

*__Richness and Beta diversity.__* We estimated richness for bats and birds in altered and unaltered sites using a corrected first-order jackknife (cJ1) [@Alroy2020] and Chao1 [@Chao1984] on the raw abundance data for all sites. The status of each site was based on the 'altered.habitat' field in the site metadata, which is empty if the site is unaltered and filled with a land use category if the site is altered. Altered sites included cropland, disturbed forest, fragment, pasture, plantation, secondary forest, inhabited area, and combined categories [@Alroy2017], and none of them had enough sites to be evaluated individually. The abundance data were converted to a presence-absence format. 
The spatial coverage of altered sites was a subset of the larger spatial area covered by unaltered sites. To minimize the effects of biogeography on our results, we removed unaltered sites that were farther from the nearest altered site than the most isolated altered site was from its nearest unaltered site (see supplement), resulting in comparable spatial coverage for both site types. The resulting dataset had `r sum(PAn[["bat"]])` occurrences of bats and `r sum(PAn[["bird"]])` occurrences of birds at `r ncol(PAn[["bat"]])` and `r ncol(PAn[["bird"]])` sites, respectively. We then calculated the beta diversity between pairs of sites for bats and birds separately, separating them into altered and unaltered groups. We used the Ochiai similarity index as the similarity measure for beta diversity, and transformed the results to z-scores to achieve normality for significance testing. Finally, we ran a principal coordinates analysis (PCoA) on the sites using the R function *cmdscale* in the stats package to check for compositional shifts between altered and unaltered habitats. We tested for significant shifts in the site centroids on the two primary PCoA axes using a simple permutation test. 

*__Biotic Interactions.__* We used dietary information for bats and birds from the Ecological Register to analyse the effects of food competition on patterns of co-occurrence (Table S1). We selected all pairs with complete dietary information and classified them as competing or non-competing. Competing pairs shared primary and secondary sources of food, but we allowed the order of these to be reversed (e.g., a frugivore-nectarivore and a nectarivore-frugivore would be equated). Non-competing pairs had no mutual food sources. Pairs with mutual and nonmutual food sources (e.g., a frugivore and an insectivore-frugivore) may experience a complex mix of effects and were therefore removed from the analysis. Although species in the same dietary guilds are not necessarily competing, pairs with high dietary overlap have a nonzero probability of experiencing competition for food, while pairs in differing guilds have no chance of competing for food. Therefore, the co-occurrence patterns of competing and non-competing groups should be different if food competition plays a role in structuring the assemblage. 

Note that any type of diffuse interaction can theoretically be represented with this approach, as long as some sort of a priori evidence exists that there may be an interaction. For instance, a more powerful version of the competition model could be created by placing only pairs with the same diet and similar body size in the competing group. Conversely, a plant-pollinator network could be decomposed into groups of pairs that facilitate one another (plant-pollinator pairs), do not interact, and even compete (plant-plant pairs that compete for pollinators or pollinator-pollinator pairs that compete for nectar). In each case, the effect of the competing group(s) is evaluated against the group of pairs that does not exhibit the interaction(s) in question. Unlike most analyses in the recent literature, pairs that lack an arbitrarily significant associations are not removed from the analyses, but instead used to estimate the differences between groups that interact and do not interact, thus shedding light on the effect of certain interaction types on the structure of communities. 

This framework also allows invesigators to quantify the effect of various external factors on the spatial outcomes of diffuse biotic interactions. In the example below, we compare assemblages from altered and unaltered habitats to evaluate the effect of habitat alteration on the outcome of food competition. However, the samples could be split up along other lines instead, such as along environmental gradients, temporally before and after disturbances, etc.

Recent studies repeatedly point out that nonrandom co-occurrence should not be construed as evidence for interaction between species pairs [@Freilich2018;@Thurman2019; @Blanchet2020]. In our framework, we have independent evidence of potential interactions (diet) and examine the relationship between putative interactions and co-occurrence, using non-interacting pairs as a control. Research using such an approach is exactly what is needed to understand under what circumstances, and to what extent, interactions lead to nonrandom spatial associations, what factors affect the relationship, and how they change under duress. 

*__The Model. __*
We assume that the probability that species A and B co-occur at $N_{AB}$ sites adheres to Fisher's noncentral hypergeometric distribution [@Fog2008],

\[
p(N_{AB}|\psi) = 
\frac{{N_{A^{+}} \choose N_{AB}}{N_{A^{-}}\choose N_{B^{+}} - N_{AB}} \psi^{N_{AB}} }
{\sum_{n} {N_{A^{+}}\choose n}{N_{A^{-}}\choose N_{B^{+}} - n} \psi^{n}}
\]

where $N_{A^{+}}$ and $N_{A^{-}}$ are the respective numbers of sites with species A present and absent, $N_{B^{+}}$ is the number of sites with species B present, and $\binom{n}{k} = \frac{n!}{k! (n-k)!}$ is a binomial coefficient. The denominator of this probability mass function (pmf) is the numerator summed over the range of possible values ($n$) for the numbers of co-occurring sites, $\text{max}(0,N_{A^{+}}+N_{A^{-}}-N_{B^{+}}) \leq n \leq \text{min}(N_{A^{+}},N_{B^{+}})$. This pmf has one fitted parameter,

\[
\psi = \frac{\pi_{A|B^{+}}}{\pi_{A|B^{-}}} =\frac{p_{A|B^{+}} (1 - p_{A|B^{-}})} {(1-p_{A|B^{+}}) p_{A|B^{-}}}
\]

where $\pi_{A|B^{+}}$ and $p_{A|B^{+}}$ are the respective odds and probability that species A occupies a site given that species B is present, and $\pi_{A|B^{-}}$ and $p_{A|B^{-}}$ are the respective odds and probability that species A occupies a site given that species B is absent. The value of $\psi$, and the calculated probability of obtaining $N_{AB}$ sites of co-occurrence, $p(N_{AB}|\psi)$, are independent of which member of the species pair is arbitrarily chosen as species A.


The $\psi$ parameter is defined on the interval $[0,\infty]$ because it is a ratio of odds. If $\psi < 1$, species A is less likely to occur at a site if species B is present, as would be expected if there is competitive exclusion among species or differences in species' habitat preferences. If $\psi > 1$, species A is more likely to occur at a site if species B is present, as would be expected if the species share habitat preferences and do not competitively exclude each other. Finally, if $\psi = 1$, the two species are independently distributed. When $\psi = 1$, Fisher's noncentral hypergeometric distribution reduces to the standard (i.e. centered) hypergeometric distribution, which has frequently been used to evaluate patterns of co-occurrence [@Arita2016]. To our knowledge, our study is the first to use Fisher's noncentral hypergeometric distribution for this purpose.


We adopt a hierarchical Bayesian modeling approach [@Gelman2014] to estimate averages of $\theta = \text{log}\psi$ for species pairs that have been subdivided into four groups, $g$, on the basis of habitat type (altered, unaltered) and diet (similar, distinct). At the lower hierarchical level, we model variation in $\theta_i$ for species pairs and groups as

\[
\theta_i = \overline{\theta_{g(i)}} + \Delta\theta_i
\]

where $g(i)$ is a function that indexes the group assignment of each species pair $i$, and $\Delta\theta_i$ is a deviation from the group mean $\overline{\theta_{g(i)}}$. We assume that these deviations are normally distributed with means of 0,

\[
p(\Delta\theta|\sigma_{g}) = \frac{1}{\sigma_{g} \sqrt{2 \pi}} e^{\Delta\theta^2 / \sigma_{g}^2}
\]

and standard deviations that vary by group, $\sigma_{g}$. At the upper hierarchical level, we assign the group averages, $\overline{\theta_g}$, normal prior distributions with means of 0 and standard deviations of 5,

\[
p(\overline{\theta_g}) = \frac{1}{5 \sqrt{2 \pi}} e^{\Delta\theta^2 / 5^2}
\]

and we assign the group standard deviations, $\sigma_{g}$, uniform prior distributions on the interval 0 to 5,

\[
p(\sigma_g) = 
\begin{cases}
    1/5 & \text{if } 0 \leq \sigma_g \leq 5 \\
    0   & \text{otherwise}
\end{cases}.
\]

These prior distributions were chosen based on preliminary analyses to allow adequate exploration of the parameter space while ensuring that the Markov chain Monte Carlo (MCMC) algorithm never halted by getting stuck in regions of negligible likelihood. These prior distributions should be viewed as weakly informative in the parlance of Bayesian analysis [@Lemoine2019]. 
The posterior distributions of the group-level averages, $p(\overline{\theta_g}|N_{AB})$, are proportional to the product of two likelihood distributions (Eqs. 1 and 3) and two prior distributions (Eqs. 4 and 5),

\[
p(\overline{\theta_g}|N_{AB}) \propto p(N_{AB}|e^{\overline{\theta_g}+\Delta\theta})
p(\Delta\theta|\sigma_g) p(\overline{\theta_g}) p(\sigma_g).
\]

This expression is a hierarchical version of Bayes formula because the likelihood is the product of two distributions, $p(N_{AB}|e^{\overline{\theta_g}+\Delta\theta}) p(\Delta\theta|\sigma_g)$, rather than being a single distribution. Consequently, the model pools information for individuals pairs to estimate the within-group standard deviations, $\sigma_g$, and then draws values of $\Delta\theta$ from a normal distribution with a mean of 0 and a standard deviation of $\sigma_g$ to yield the pair-level estimates, $\theta_i$ (Eq. 2). Data pooling, in turn, results in shrinkage of pair-level estimates, $\theta_i$, toward the population-level means, $\overline{\theta_g}$.


A hierarchical approach is desirable here because pairs yielding weaker evidence (as indexed by smaller likelihoods) exhibit greater shrinkage, and pairs yielding stronger evidence are assigned greater weight in calculating the group-level averages, $\overline{\theta_g}$. Thus, this model fitting procedure accounts for the fact that species pairs with few records of occurrence, by themselves, yield little information on the value of $\theta$, and hence $\psi$. For example, if species A and B are both present at 5 of 25 sites, but there are no sites of co-occurrence (i.e. $N_{AB} = 0$, $N_{A^{+}} = 5$, $N_{A^{-}} = 20$, $N_{B+} = 5$), the maximum likelihood estimate is $\psi = 0$, implying complete segregation of species A and B. However, in this example, evidence of segregation is actually rather weak, as evidenced by the fact that maximum likelihood calculations (based on Eq. 1) yield a 95% confidence interval for $\psi$ that actually encompasses strong?? repulsion to strong attraction (0 to 6.1).


We estimate posterior distributions using two distinct approaches. First, we use hierarchical Bayesian MCMC methods to analyse full datasets, $N_{AB}$, comprised of all $S (S - 1)/2$ pairwise counts of co-occurrence for each of the two habitat types, where $S$ is the number of species used to calculate the set of pairwise estimates. This approach has the advantage of making use of all available data. However, it also has the disadvantage of not allowing for formal statistical evaluation because a single occupancy distribution for each species is used to generate $(S - 1)/2$ pairwise estimates of co-occurrence, resulting in non-independence.


Second, to address the issue of non-independence, we use Bayesian bootstrap aggregation [@Huggins2020], to obtain "bagged" estimates of posterior distributions, $p^{*}(\overline{\theta_g}|N_{AB}^{*}$), for independent samples, $N_{AB}^{*}$. Our approach entails the following: (\textit{i}) construct $D$ datasets comprised of independent co-occurrence counts ($N_{AB}^{*}$: $N_{AB}^{(1)}$, $N_{AB}^{(2)}$, ... $N_{AB}^{(D)}$); (\textit{ii}) sample the posterior distributions of the model parameters for each independent sample using Bayesian MCMC; (\textit{iii}) average over the $D$ posterior distributions obtained in (\textit{ii}) to approximate the posterior distribution for independent samples:

\[
p^{*}(\overline{\theta_g}|N_{AB}^*) \approx \frac{1}{D} {\sum_{n = 1}^{D} p(\overline{\theta_g}|N_{AB}^{(n)})}
\]

For (\textit{i}), we first randomly permute a vector of species indices $1,...,S$, and then pair adjacent entries in the permuted vector, leaving $\lfloor S/2 \rfloor$ independent pairs, where $\lfloor x \rfloor$ is the largest integer $\leq x$. There are $S!/2^{\lfloor S/2 \rfloor}/\lfloor S/2 \rfloor!$ distinct independent datasets that can be constructed in this way because there are $S!$ ways permute the vector of $S$ species, $2^{\lfloor S/2 \rfloor}$ distinct ways to swap the ordering of species A and B within pairs, and $\lfloor S/2 \rfloor!$ ways to order the pairs. The number of distinct independent samples is far too large to consider them all. For example, with 100 species, there exist $100!/2^{50}/50! \approx 2.7\times 10^{78}$ distinct independent datasets of 50 pairs that can be constructed. We therefore approximated the bagged posterior distribution using $D$ = 100, as is standard [@Huggins2020].

For both types of analyses described above, we estimate the posterior distributions using the R package rjags, which provides an interface from R to the JAGS library for Bayesian data analysis [@Lunn2009; @Plummer2006]. To approximate the posterior distributions, we generated 3 MCMC chains of $5^5$ steps each in JAGS, including a burn-in period of 10000 steps, and a thinning interval of 100. We then inspected MCMC plots for the 3 chains and calculated Gelman Rubin statistics, $\hat{R}$, to ensure convergence [@Gelman2014]. For step (\textit{iii}) of our second analysis, we simply concatenated the posterior samples obtained from the $D=100$ trials because each MCMC trial yields a posterior sample of 
identical size, and all samples are given equal weight when calculating the bagged posterior distributions (Eq. 7).

```{r, echo = FALSE}
# calculate number of species per guild (in the functional analysis)
s <- spp %>% filter(rownames(.) %in% unlist(map(PAn, rownames))) %>% group_by(life.form, guild) %>% dplyr::summarise(count = length(guild))

```

In this framework, a change in the posterior distributions of $\psi$ and $\sigma_{g}$ can exhibit several patterns, which point to various biological processes. Competing pairs can display lower $\psi$ than non-competing pairs, which means that diffuse competition tends to lead to exclusion with respect to opportunity for co-occurrence. This is the case even if all $\psi$ are positive, as exclusion does not necessarily present as a negative association. Because competing and non-competing pairs are comprised of the same species data in different pairwise arrangements, the $\psi$ of non-competing pairs represents the opportunity for coexistence in the absence of food competition. A deviation toward lower $\psi$ from this baseline is evidence that competing pairs are not coexisting as often as expected--hence, exclusion. Conversely, a higher $\psi$ in competing pairs confirms that similarity in resource use leads to co-occurrence without causing exclusion, suggesting that competing pairs tend to partition or share adequate resources. If the $\psi$ of competing and non-competing pairs do not differ significantly, but the $\sigma_{g}$ (variance) of competing pairs is higher, this points to stronger spatial patterns (both coexistence and exclusion) in pairs that compete for food, and vice versa. If there is no difference in $\psi$ or $\sigma_{g}$ between the two groups, then there is insufficient evidence to support the hypothesis that diffuse competition is influencing the structure of the assemblage at the landscape scale.

The $\psi$ and $\sigma_{g}$ of competing and non-competing pairs might also differ between altered and unaltered sites in our example. If the relationship between competing and non-competing pairs is different, this means that alteration has changed the outcome of biotic interactions, e.g., by promoting partitioning over exclusion or vice versa. More subtly, the extent of disparity between the two groups could differ without qualitatively changing the relationship, which indicates that naturally existing mechanisms have been enhanced or dampened. On the other hand, $\psi$ or $\sigma_{g}$ could simply be higher or lower across the board, suggesting that alteration leads to changes in community structure that do not necessarily involve the rewiring of competitive interations.  

*__The effect of turnover.__*
Overall changes observed in association patterns could result from pairs changing their spatial behaviour or their competition intensity in altered vs. unaltered habitats. Conversely, a shift in species composition (e.g. the removal or introduction of interaction partners), and therefore the presence of a different suite of pairs, could also cause disparities between the two habitat types. To investigate these possibilities, we ran the models with all species and then repeated them with only species occurring at least once in both habitat types. If the results of the two model sets are very similar, we can conclude that the results are driven by changes in the spatial behaviour of species occurring in both site types. If the two model sets are different but both show significant effects, likely both turnover and changes in preserved interactions are occurring. Furthermore, the differences between the two outputs can be used to determine which changes are due to which mechanism. Model effects are due to turnover alone if the model set using only shared species has no significant results while the model set using all species has significant differences.


#### Results and Discussion 
```{r, echo = FALSE}
# richness - p values
pcj1 <- cJ1 %>% group_by(taxon) %>% summarise(w=wilcox.test(richness~status, paired=FALSE)$p.value) %>% ungroup() %>% select(w)

pcha <- chao %>% group_by(taxon) %>% summarise(w=wilcox.test(richness~status, paired=FALSE)$p.value) %>% ungroup() %>% select(w)

# beta-diversity
beta <- beta.types(PAn, unalt_sites)
  # p-values
pbeta <- beta %>% filter(unalt.pair != "Unaltered-Altered") %>% mutate(similarity = qnorm(Z.Score)) %>% split(.$taxon) %>% purrr::map(~wilcox.test(data = ., similarity~unalt.pair, paired=FALSE))

# occupancy calculations
occ <- map(PAn[taxa], t)  %>% map(data.frame) %>% map(~split(., rownames(.) %in% unalt_sites)) %>% 
  map(map, ~colSums(.)/nrow(.)) %>% map(map, data.frame) %>% map(~merge(.[[1]], .[[2]], by = 0)) %>% map(setNames, c("name", "altered", "unaltered")) %>% bind_rows(.id = "taxon")
docc <- occ %>% group_by(taxon) %>% summarise(
  declined = length(which(altered < unaltered)), 
  increased = length(which(unaltered < altered)), 
  extirpated = length(which(altered == 0 & unaltered > 0)), 
  appeared = length(which(altered > 0 & unaltered == 0)), 
  shared = length(which(altered > 0 & unaltered > 0)), 
  total = length(altered))
```


*__Richness and beta diversity.__* Based on Chao 1 and cJ1, altered sites have lower alpha richness to unaltered sites, however the difference is not significant (cJ1 p-values  = `r round(pcj1[1,],3)` and `r round(pcj1[2,],3)`, and Chao 1 p-values  = `r round(pcha[1,], 3)` and `r round(pcha[2,], 3)` for bats and birds, respectively). Average richness for bat samples in unaltered habitats was 
`r cJ1 %>% group_by(taxon, status) %>% summarise(mean = mean(richness)) %>% {.[.$taxon == "bat" & .$status == "Unaltered",3]} %>% round(2)` (cJ1) and 
`r chao %>% group_by(taxon, status) %>% summarise(mean = mean(richness, na.rm = T)) %>% {.[.$taxon == "bat" & .$status == "Unaltered",3]} %>% round(2)` (Chao1), and
`r cJ1 %>% group_by(taxon, status) %>% summarise(mean = mean(richness)) %>% {.[.$taxon == "bat" & .$status == "Altered",3]} %>% round(2)` (cJ1) and 
`r chao %>% group_by(taxon, status) %>% summarise(mean = mean(richness, na.rm = T)) %>% {.[.$taxon == "bat" & .$status == "Altered",3]} %>% round(2)` (Chao 1) in altered habitats. Average richness for bird samples  was 
`r cJ1 %>% group_by(taxon, status) %>% summarise(mean = mean(richness)) %>% {.[.$taxon == "bird" & .$status == "Unaltered",3]} %>% round(2)` (cJ1) and 
`r chao %>% group_by(taxon, status) %>% summarise(mean = mean(richness, na.rm = T)) %>% {.[.$taxon == "bird" & .$status == "Unaltered",3]} %>% round(2)` (Chao 1) in unaltered habitats, and 
`r cJ1 %>% group_by(taxon, status) %>% summarise(mean = mean(richness)) %>% {.[.$taxon == "bird" & .$status == "Altered",3]} %>% round(2)` (cJ1) and 
`r chao %>% group_by(taxon, status) %>% summarise(mean = mean(richness, na.rm = T)) %>% {.[.$taxon == "bird" & .$status == "Altered",3]} %>% round(2)` (Chao 1) in altered habitats. 
For bats and birds, respectively, 
`r round(docc[1,3] / docc[1,7]*100)`% and 
`r round(docc[2,3] / docc[2,7]*100)`% of species increased their occupancies in altered habitats, and of these, 
`r round(docc[1,5] / docc[1,3]*100)`% and 
`r round(docc[2,5] / docc[2,3]*100)`%, respectively, appeared only in altered habitats. Overall, however, 
`r round(docc[1,2] / docc[1,7]*100)`% of all bat and 
`r round(docc[2,2] / docc[2,7]*100)`% of all bird species decreased their occupancies in altered habitats, and of these, 
`r round(docc[1,4] / docc[1,2]*100)`% and 
`r round(docc[2,4] / docc[2,2]*100)`% disappeared altogether. Relatively many species were sampled only in altered habitats (13% of bats and 27% of birds). These species may exist in unaltered habitats. However, as we took measures to standardise sampling between altered and unaltered sites, these species likely represent a group whose abundances have been substantially increased in altered sites. The converse may be true for some species that were only sampled in unaltered sites.

Altered sites had the lowest beta diversity in bats, decreasing significantly from unaltered sites  (Wilcoxon rank sum test, p _bat_ = `r round(pbeta[[1]]$p.value, 3)`). Birds also exhibited higher beta diversity in unaltered sites, but the difference was not significant (p _bird_ = `r round(pbeta[[2]]$p.value, 3)`). Bats had an order of magnitude higher similarity than birds overall, indicating that spatial turnover in birds is much higher and suggesting the two taxa have very different community structures. This is unsurprising because Neotropical bats frequently have geographic ranges spanning almost the entire realm, unlike Neotropical birds.

```{r, echo = FALSE}

# composition PCoA

dist <- map(PAn, ochiaiMatrix) %>% map(as.dist, upper = F) %>% map(~return(1-.)) 
ord <- map(dist, cmdscale, k = 2) %>% map(data.frame)
ord <- map(ord, ~merge(., y = sitedat, all.x = T, all.y = F, by.x = 0, by.y = "sample.no"))

# Significance test on centroids
w <- numeric()
for(j in 1:length(ord)){
  i <- ord[[j]]
  d <- numeric()
  for(r in 1:1000){
    i$rand = round(runif(n = nrow(i), min = 0, max = 1), 0)
    cent <- i %>% group_by(rand) %>% dplyr::summarise(x = mean(X1), y = mean(X2))
    d[r] <- spDists(as.matrix(cent[,c(2:3)]))[2]
  }
  cent <- i %>% group_by(status) %>% dplyr::summarise(x = mean(X1), y = mean(X2))
  obs <- spDists(as.matrix(cent[,c(2:3)]))[2]
  w[j] <- wilcox.test(d, obs)$p.value
}
w <- round(w, 3)
```

Figure 1 depicts the composition of altered and unaltered sites plotted by the first two principal coordinates. The permutation tests detected no significant compositional differences between altered and unaltered sites (p-values = `r w[1]` for bats and `r w[2]` for birds). This indicates that the considerable faunal turnover observed across altered and unaltered sites is not atypical, even across sites in the same category.

In summary, unaltered and altered habitats did not differ significantly in species richness, nor did we find differences in composition between unaltered and altered habitats. This suggests that biogeographic location is more important in determining compositional turnover than habitat alteration. However, beta diversity was lower in altered habitats for bats, similar to the results of Kay _et al._ [-@Kay2017] for lizards in Australia. This paper therefore joins a long parade of studies showing that habitat alteration can cause homogenisation without reducing richness [@Toth2014; @Dornelas2014; @McKinney2006; @McKinney1999; @Trentanovi2013; @Knop2015]. We found this pattern even though our altered sites encompassed a wide variety of habitat types. Such homogenisation is often driven by the expansion of a few cosmopolitan species while rare and sensitive species are extirpated [@McKinney1999; @Toth2014]. 

*__Biotic interactions.__*
Bagged interaction models showed no significant difference in $\psi$ or $\sigma_{g}$ of any group, but non-bagged models showed significant differences in all instances (Figs 2-3, bottom row). Qualitative differences in bagged models weakly support the results of the non-bagged models, so rather than discussing both, we will focus on the results of the non-bagged models. The reality is likely somewhere between the two sets of results, but the bagged models evidently discard too much information to muster enough power to detect the signal observed in the non-bagged models. 

Competition for food affected the spatial community structure of both bats and birds, demonstrated by offsets in the $\psi$ and variance ($\sigma_{g}$) posteriors in both taxa (Figs. 2-3). Competing pairs consistently exhibited significantly higher variance than their non-competing counterparts, supporting the conclusion that nondrandom spatial patterns are manifested more strongly by species that share food sources. This is backed up by the observation that competing pairs nearly always had equal or more extreme (farther from zero) $\psi$ posteriors than their non-competing counterparts. This result is not surprising, given that we would expect species with similar food resources to either aggregate in the same areas (i.e. sites with an abundance of their food source), or, if there is strong competition or a dearth of resources, to segregate between sites more often than pairs in the same environment that do not share food sources.

Overall, birds tended toward repulsive assiociations while bats tended toward attractive associations. This observation should likely be taken as a fundamental difference in the ecology of birds and bats and is supported by our beta-diversity results. Bats tend to exhibit limiting morphological similarity [@Kingston2000], share roosts [@Swift1983], display varied foraging behaviours [@Swift1983; @Denzinger2013], and micro-partition resources, habitats and foraging times [@Aldridge1987; @Nicholls]. Neotropical birds, meanwhile, are well known for interspecific aggression [@Jankowski2010; @Freeman2016; @Freeman2016a], separating out along elevational gradients [@Jankowski2010], and competitive exclusion [@Terborgh1975; @Remsen1995]. Even non-competing bird pairs are far less likely to co-occur than non-competing pairs of bats, suggesting that natural beta diversity and abiotic niche specialization are much more pronounced in birds than bats. Conversely, bird pairs that do not compete for food may still compete for other resources, such as territory and nesting sites. 

*__Habitat alteration__*
In unaltered habitats, both bats and birds displayed little to no exclusion, with competing pairs tending to coexist more readily than non-competing pairs. The pattern is manifested as weaker negative $\psi$ for competing birds (vs. non-competing birds) and stronger positive $\psi$ for competing bats (vs. non-competing bats). Because competing variances are also significantly higher, mutual food sources evidently tend to encourage resource sharing and partitioning in the wild even in models where $\psi$ was not significantly offset, such as models including rare species, with occasional cases of exclusion. In both taxa, this relationship is lost in altered habitats. 

For bats, the offset in $\psi$ between competing and non-competing pairs disappears, and variances are higher for both competing and non-competing groups. This shows that while resource partitioning is still occurring, exclusion is much more common for competing bat pairs under altered habitats than unaltered habitats. Models including all and common species agree in this respect, but the models including all species have an additional feature: lower $\psi$ for both competing and non-competing groups with respect to the unaltered baseline. This evidence supports the notion that for bats, natural coexistence is less common in altered habitats, particularly for rarer species, and partly irrespective of competitive status. 

For birds, the signal of resource sharing or partitioning observed in unaltered habitats is not only lost but completely upended, with non-competing pairs exhibiting dramatically higher $\psi$ and lower variance while competing pairs remain at unaltered levels (in the case of common species pairs) or even below them (in the case where lower-incidence species pairs are included). This could be interpreted to mean that competing pairs are not stronly affected by alteration, however, the $\psi$ of non-competing pairs (which are constructed from different pairings of all the same species as competing pairs) suggests that altered habitats supply many more opportunities for co-occurrence than unaltered habitats (for instance, through resource concentration or niche construction), and competing pairs are unable to partake in these opportunities. This causes them to instead exhibit more exclusion than the evidence says we should expect. 

*__The effect of turnover__*
We re-ran our models (both "full" and "common-only") excluding species that were not found at least once in both altered and unaltered habitats. The purpose was to discover whether (a) compositional disparities between the two habitat types are the main drivers of the observed patterns, (b) actual changes in spatial behaviour of conserved species is different, or (c) both. There were strong similarities beween the turnover and no-turnover models. In bats, there was very little difference between the two model sets, supporting (b). In birds, the same relationships are observed within habitats, but altered pairs exhibit universally lower $\psi$ than they do in the model sets containing turnover. This suggests that the opportunities for co-occurrence are amplified primarily for species that were only sampled in altered habitats (i.e. synanthropic species), only slightly amplified for others, and supports hypothesis (c). However, competing pairs still exhibit exclusion in altered habitats, and this is very pronounced in the models with no turnover, with $\psi$ significantly lower than any other group, meaning that altered habitats cannot sustain diverse sets of competing pairs, irrespective of whether the species comprising them are sensitive to human disturbance.  

*__Altered site types.__*
 Strong aggregations form when species occur together at a relatively small number of sites and are both absent from other sites. To help understand our results, we calculated the representation of dietary guilds at various different types of altered sites (Fig. S6). Carnivore-insectivorous (22 species) and frugivorous bats (69 species) co-occur disproportionately in plantations. Plantations and forest fragments support the highest proportion of insectivore bats (80 species), and nectarivores (21 species) co-occur disproportionately in plantations and croplands (see supplement and Fig. S6). 

For birds, inhabited sites support a disproportionate ratio of birds with simple diets (nectarivores, frugivores, invertivores, and granivores), though the sample size is too small to derive any conclusions. Croplands are the main supporter of frugivore-granivore birds.

#### Conclusions 

 Our approach confirms that the effect of diffuse food competition on community structure can be detected using co-occurrence analysis, so long as independent data suggesting an a-priori interaction can be collected. There were differences in the community assembly of bats and birds in unaltered habitats, but both species exhibited a preference for coexistence in competing pairs with respect to non-competing pairs. Natural patterns changed in the presence of habitat alteration, even though richness, turnover, and composition analyses were largely unable to identify significant differences. Altered habitats afford fewer opportunities for the coexistence of bats but more opportunities for the coexistence of birds, especially those unique to altered habitats. Competing pairs, however, exhibited more exclusion than expected in both taxa, suggesting that altered habitats are unable to locally support rich communities of competing species the way unaltered habitats do. The loss of competitive interactions in altered sites represents a loss of ecosystem functionality. In cases where competing pairs limit one another's abundance, this loss of functionality could cause runaway abundance in a few dominant species, and cause significant damage if the dominant competitor happens to be a pest species (e.g. one that destroys crops), or if the excluded species is instrumental in ecosystem services, such as controlling pests or facilitating pollinators.
 
Although some differences did exist, the qualitative responses of competing bats and birds to habitat alteration had strong parallels. Overall, habitat alteration reduces or reverses the effect of competition on community structure in both bats and birds, with restricted species, whose ability to coexist is greatly compromised by disturbance, being of particular concern as altered habitats become increasingly widespread. 


#### Acknowledgements 
The authors would like to thank the members of the Macquarie University Paleobiology Lab, whose discussions helped facilitate the improvement of this manuscript. ABT was partially supported by an IMQRES scholarship at Macquarie University. 

### Figures

```{r echo=FALSE, include = T, fig.height=4, fig.width=9, ord}
# Ordination
dist <- map(PAn, ochiaiMatrix) %>% map(as.dist, upper = F) %>% map(~return(1-.)) 
ord <- map(dist, cmdscale, k = 2) %>% map(data.frame)
ord <- map(ord, ~merge(., y = sitedat, all.x = T, all.y = F, by.x = 0, by.y = "sample.no"))

#PCoA plot
  p1 <- ggplot(ord[[1]], aes(x = X1, y = X2, col = status)) + geom_point() + labs(x = "Comp1", y = "Comp2", col = "alteration") + theme(axis.text = element_text(size = 12)) + labs(col = "status") + scale_colour_manual(values = c("red", "dodgerblue"))
  
  p2 <- ggplot(ord[[2]], aes(x = X1, y = X2, col = status)) + geom_point() + labs(x = "Comp1", y = "Comp2", col = "alteration") + theme(axis.text = element_text(size = 12)) + labs(col = "status") + scale_colour_manual(values = c("red", "dodgerblue")) 
  
  p <- plot_grid(p1+theme(legend.position = "none"), 
                 p2+theme(legend.position = "none", 
                axis.title.y = element_blank()), ncol = 2, labels = c("A","B"), align = "lr")
  plot_grid(p, get_legend(p1), rel_widths = c(1, .2))

```

__Figure 1.__ Principal coordinates analysis of altered and unaltered sites for bats (A) and birds (B). There is no significant difference between the composition of altered and unaltered sites for either taxon, based on a permutation test of the site type centroids (p-values = `r w[1]` and `r w[2]` for bats and birds, respectively). 

```{r echo=FALSE, include = T}
colors <- c("#FFCB5C", "#FF791F", "#2F99DC", "#084887")

specs <- list(geom_density(lwd = 1, alpha = .3),
              facet_wrap(parameter~., scales = "free_x"), 
              scale_color_manual(values = colors), 
              scale_fill_manual(values = colors))


```

```{r echo=FALSE, include = T}
load("../Results/Omega/interaction/out_jagsfit_bat_medianTRUE_100reps_interaction_baggingFALSE.RData")
a1 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs
load("../Results/Omega/interaction/out_jagsfit_bat_medianFALSE_100reps_interaction_baggingFALSE.RData")
a2 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")
load("../Results/Omega/interaction/out_jagsfit_bat_medianTRUE_100reps_interaction_baggingTRUE.RData")
a3 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")
load("../Results/Omega/interaction/out_jagsfit_bat_medianFALSE_100reps_interaction_baggingTRUE.RData")
a4 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")

legend <- get_legend(a1+ theme(legend.box.margin = margin(0, 0, 0, 7)))

p1 <- plot_grid(a1 + theme(legend.position = "none"), a2, a3, a4, align = "hv", nrow = 2)
plot_grid(p1, legend, nrow = 1, rel_widths = c(2, 0.8))

```

__Figure 2.__ Results of bat interaction models, depicting $\psi$ and $\sigma_{g}$, with non-bagged models in the top row and bagged models in the bottom row. Left column includes species with occurrences above the median for that taxon and habitat type. Right column includes all species.

```{r echo=FALSE, include = T}
load("../Results/Omega/interaction/out_jagsfit_bird_medianTRUE_100reps_interaction_baggingFALSE.RData")
r1 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs
load("../Results/Omega/interaction/out_jagsfit_bird_medianFALSE_100reps_interaction_baggingFALSE.RData")
r2 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")
load("../Results/Omega/interaction/out_jagsfit_bird_medianTRUE_100reps_interaction_baggingTRUE.RData")
r3 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")
load("../Results/Omega/interaction/out_jagsfit_bird_medianFALSE_100reps_interaction_baggingTRUE.RData")
r4 <- ggplot(out %>% filter(!parameter %in% c("deviance")), aes(x = value, col = status_dietmatch, fill = status_dietmatch)) + 
  specs + theme(legend.position = "none")

legend <- get_legend(r1+ theme(legend.box.margin = margin(0, 0, 0, 7)))

p1 <- plot_grid(r1 + theme(legend.position = "none"), r2, r3, r4, align = "hv", nrow = 2)
plot_grid(p1, legend, nrow = 1, rel_widths = c(2, 0.8))



```

__Figure 2.__ Results of bird interaction models, depicting $\psi$ and $\sigma_{g}$, with non-bagged models in the top row and bagged models in the bottom row. Left column includes species with occurrences above the median for that taxon and habitat type. Right column includes all species.

## References



