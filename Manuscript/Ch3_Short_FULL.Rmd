---
title: Ecological interactions disrupted by habitat alteration in the Neotropics
output:
  bookdown::word_document2: default
bibliography: References.bib
csl: nature.csl

---

__Authors:__ Anikó B. Tóth^1^*, Andrew P. Allen^2^, S. Kathleen Lyons^3^, John Alroy^2^

__Affiliations:__

^1^ Centre for Ecosystem Science, School of Biological, Earth and Environmental Sciences, UNSW, Sydney, NSW 2052, Australia.

^2^ Department of Biological Sciences, Macquarie University, New South Wales 2109, Australia.

^3^ School of Biological Sciences, University of Nebraska-Lincoln, Lincoln, Nebraska 68588, USA.



__Abstract:__ 
Ecological interactions help determine the distribution of species across landscapes and play crucial roles in ecosystem services such as pollination, seed dispersal, and pest control [@Cardinale2012]. Human disturbances, particularly habitat alteration, have the potential to modify or erase ecological interactions [@Dore2021; @DeAssisBomfim2018] and so jeopardise the processes they control. While examples of interactions becoming rewired under human influence have been recorded, studies of this process for speciose assemblages at regional to continental scales are uncommon [e.g., @Winfree2018] and obstructed by logistical difficulties [@Dore2021]. The consequences for ecological communities and people are therefore poorly understood. Here we show that human habitat alteration is associated with a decrease in the spatial aggregation of Neotropical bat pairs and bird pairs that share similar dietary requirements. We find that groups of species pairs with similar vs. different diets have positive spatial associations on average, but pairs within dietary guilds have stronger associations than pairs with disparate diets when habitats are relatively intact. Our results suggest that species with similar resource requirements typically coexist in relatively intact natural settings. By contrast, exclusion becomes more common (though not dominant) when habitats are altered. Altered habitats thus fail to support the coexistence of diverse competitive interactions, reversing patterns observed in the wild.


```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(igraph)
library(reshape2)
library(vegan)
library(sp)
library(stringi)
library(parallel)
library(magick)
library(lsa)

knitr::opts_chunk$set(include = FALSE)

inline_hook <- function(x) {
  if (is.numeric(x)) {
    format(x, digits = 2)
  } else x
}

knitr::knit_hooks$set(inline = inline_hook)

## Load helper functions
source('../Code/HelperFunctions.R')
## Prep raw data
source('../Code/Data_Prep.R')

```


__Main text:__

Biological interactions are essential for maintaining biodiversity because they directly affect which species can coexist. Interactions are one of the four main drivers of species distributions [@McGill2010] and key moderators of ecosystem functioning [@Cardinale2012]. Although this interpretation is still contentious [@McGill2010; @Araujo2013; @Ezard2016], it is increasingly recognised that biotic interactions across assemblages can scale up to influence community assembly at much larger spatiotemporal scales than that of individual encounters [@Araujo2007; @Pollock2014; @Fraser2020]. For example, competition and facilitation can influence the modern distribution of species at regional scales [@Gotelli2010], and at continental scales over millennia [@Toth2019], and drive the diversification and extinction of entire clades over millions of years [@Sepkoski1984; @Alroy2010; @Fraser2020].
 
Paradoxically, despite agreement that interactions affect species distributions on either small or very large spatiotemporal scales, the idea that the footprints of biological interactions are broadly discernible from modern occurrence data at regional or continental spatial scales is famously contentious[@Diamond1975; @Gilpin1982; @Sanderson2009; @Connor1979; @Gotelli2002; @Sfenthourakis2005; @Gotelli2010; @Connor2013]. The debate is largely driven by the difficulty of distinguishing the effect of interactions from those of other landscape variables such as biogeographic historical effects, dispersal limitations, and habitat preferences [@Gotelli2010]. Furthermore, the relatively low occupancies of many species mean that there is insufficient occupancy data to provide biological information on the vast majority of possible pairwise interactions, leaving scientists to focus mainly on a relatively small number of common species. 

These questions are also contentious partly because human activities may alter community assembly processes. For example, humans have been implicated in homogenising communities [@Fraser2022] even when species richness is stable [@Tóth2014; @Dornelas2014], and reducing species co-occurrences [@Lyons2016]. Complicating matters, rapid change can rewire biological interactions [@Bartley2019] without necessarily adding or removing species [@Tylianakis2017]. Evidence that human disturbance can decouple predator-prey interactions [@Rodewald2011], increase competition for pollinators [@Holzschuh2011], and simplify or break apart interaction networks [@Haddad2000; @DeAssisBomfim2018] has been gathered mainly at local scales on systems with only a few species due to logistical challenges. Patterns documenting changing interactions in entire assemblages are also rare, except for laboriously compiled interaction data spanning decades, such as plant-pollinator networks [@Dore2021]. Nonetheless, these are beset by sampling inconsistencies [@Dore2021]. Thus, there is an urgent need to fill this gap in our understanding of how interactions scale up and how human disturbance might alter such community assembly processes.

Here, we explore how one interaction type (food competition) measurably influences species co-occurrences in Neotropical birds and bats. We further demonstrate how human habitat alteration changes the effects of food competition on the spatial associations of species pairs, meaning the degree to which pairs co-occur at the same sites more or less often than expected based a non-competing set of pairs that serves as a control. We analyse assemblages of Neotropical bats and understory birds downloaded from the Ecological Register [@Alroy2015b]. The dataset comprises `r length(which(PAn[["bat"]] > 0))` occurrences of bats and `r length(which(PAn[["bird"]] > 0))` occurrences of birds at `r ncol(PAn[["bat"]])` and `r ncol(PAn[["bird"]])` sites, respectively. The sites in the Register are classified into two levels of degradation (altered and intact habitats: Fig. S1). We begin by running a suite of classical community analyses to illustrate the differences detectable in altered and intact faunas based on traditional approaches. Next, we introduce a statistical model that estimates an underlying association parameter which describes the spatial patterns in groups of species pairs. Our analysis demonstrates that habitat degradation influences spatial association patterns among competitors by altering – or even reversing – the average outcome of food competition at regional to continental scales.

```{r biogeocorr, echo = FALSE}
#### Match Biogeography ####
# save original data properties for use in methods section
norig.bat.sites <- ncol(PAn[["bat"]])  #sites
norig.bird.sites<- ncol(PAn[["bird"]])

norig.bat.indi <- sum(PAn[["bat"]])  # individuals
norig.bird.indi<- sum(PAn[["bird"]])

norig.bat.occur <- length(which(PAn[["bat"]] > 0)) # occurrence records
norig.bird.occur<- length(which(PAn[["bird"]] > 0))

norig.bat.samp <- median(colSums(PAn[["bat"]])) # median individuals per site
norig.bird.samp <- median(colSums(PAn[["bird"]]))

# separate altered and intact sites
PAnu <- PAn %>% map(~return(.[,colnames(.) %in% unalt_sites])) # separate intact
PAna <- PAn %>% map(~return(.[,!colnames(.) %in% unalt_sites])) # and altered sites

coords <- sitedat %>% select(taxon, p.sample, latitude, longitude) %>% distinct() %>% split(.$taxon)

# Remove intact or altered sites that are not near a site of the other type. This is done to ensure the two sets have similar biogoegraphical distributions.
coords1 <- purrr::map2(coords, PAnu, function(x, y) x[x$p.sample %in% colnames(y),])
coords2 <- purrr::map2(coords, PAna, function(x, y) x[x$p.sample %in% colnames(y),])
keep <- map2(coords1, coords2, matchbiogeo) %>% map(unlist)

PAn <- map2(PAn, keep, function(x, y) return(x[,as.character(y)]))
PAn <- map(PAn, clean.empty, minrow = 1) # remove any species that now have no occurrences

# recalculate alt/unalt split from new PAn
PAnu <- PAn %>% map(~return(.[,colnames(.) %in% unalt_sites]))
PAna <- PAn %>% map(~return(.[,!colnames(.) %in% unalt_sites]))

# coords of sites we kept, for plotting later.
coords1.keep <- purrr::map2(coords, PAnu, function(x, y) x[x$p.sample %in% colnames(y),])
coords2.keep <- purrr::map2(coords, PAna, function(x, y) x[x$p.sample %in% colnames(y),])

```


```{r richness, message=FALSE, warning=FALSE, include=FALSE}
###### Richness - run using raw abundance data ####
# can only be run on raw data because it requires a singleton count of abundances.
rich <- list(cJ1 = map(PAn, map_dbl, cJ1rich) %>% map(~split(., names(.) %in% unalt_sites)) %>% # corrected 1st order jackknife
               map(map, cbind) %>% map(map, data.frame), 
             chao = map(PAn, map_dbl, chao1) %>% map(~split(., names(.) %in% unalt_sites)) %>%  # chao1
               map(map, cbind) %>% map(map, data.frame) , 
             fa = map(PAn, map_dbl, fisher.alpha) %>% map(~split(., names(.) %in% unalt_sites)) %>%  # fisher's alpha
               map(map, cbind) %>% map(map, data.frame)) %>% 
  map(map, bind_rows, .id = "status") %>% map(bind_rows, .id = "taxon") %>% bind_rows(.id = "metric") %>% 
  setNames(c("metric", "taxon", "status", "richness")) %>% 
  mutate(status = recode(status, `FALSE` = "Altered", `TRUE` = "Intact"))

# Summary
rsumm <- rich %>% group_by(metric, taxon, status) %>% summarise("mean richness" = mean(richness, na.rm = T), "median richness" = median(richness, na.rm = T))
# Significance
rsig <- rich %>% group_by(metric, taxon) %>% summarise(p=wilcox.test(richness~status, paired=FALSE)$p.value, 
                                               W=wilcox.test(richness~status, paired=FALSE)$statistic)

```


```{r betacomp, message=FALSE, warning=FALSE, include=FALSE}

#### Beta diversity and composition analyses #####
output <- data.frame()
input <- list(abundance = PAn, binary = tobinary(PAn))

for(d in c("binary", "abundance")){
  for(metric in c("Jaccard", "Ochiai")){

PA <- input[[d]]
if(metric == "Jaccard") dist <- map(PA, ~t(.)) %>% map(vegdist, method = "jaccard") else dist <- map(PA, as.matrix) %>% map(cosine) %>% map(as.dist, upper = F) %>% map(~return(1-.))

if(metric == "Ochiai" && d == "abundance") metric <- "Cosine similarity"
# beta diversity using betadisper
beta <- map2(dist, PA, function(x, y) betadisper(x, group = colnames(y) %in% unalt_sites) %>% anova)

# compositional change using adonis
data <- map(PA, ~t(.x) %>% data.frame() %>% rownames_to_column("p.sample") %>% mutate(ID = colnames(.x) %in% unalt_sites))
comp1 <- map2(dist, data, function(x, y) adonis(x~ID, data = y, permutations = 10000))

# compositional change using canonical correspondence analysis
dat <- map(data, select, contains("_"))
comp2 <- map2(dat, data, function(x, y) cca(x~ID, data = y) %>% anova.cca)

bdc <- list(beta, map(comp1, ~.x$aov.tab), comp2)
output <- rbind(output, data.frame(analysis = c("beta dispersion", "adonis", "cca"), 
                             data = d, 
                             metric = c(metric, metric, "NA"), 
                             map_df(bdc, map_df, ~.x$P[1]) %>% setNames(c("p bat", "p bird")), 
                             map_df(bdc, map_df, ~.x$F[1]) %>% setNames(c("F bat", "F bird"))))
  }
    
}
```

Classical community analyses conducted using several metrics produce inconsistent results with respect to whether community patterns differ between altered and intact sites. Specifically, bird assemblages experience significant differences in species composition without changes in richness (Extended Data Table 1) or beta diversity (Extended Data Table 2). Bats have no significant disparity in beta diversity, but possible differences in richness (Extended Data Table 1) and composition, depending on the analysis and metric used (Extended Data Table 2). A multidimensional scaling analysis demonstrates that compositional dissimilarities between altered and intact habitats are not visually striking (Fig. 1). In sum, classical analyses detect possible differences in patterns between habitat types, but they are not necessarily robust. 

```{r message=FALSE, warning=FALSE, include=FALSE}
tables <- PAn %>% tobinary() %>% map(~t(.)) %>% map(as.data.frame) %>% map(~split(., f = rownames(.) %in% unalt_sites)) %>% 
  map(map, ~t(.)) %>% map(map, clean.empty) %>% purrr::map(setNames, c("altered", "intact"))

original <- map(tables, map, ~expand.grid(Sp1 = rownames(.x), Sp2 = rownames(.x))) %>% map(map, diet_cat, spp, related = TRUE) %>% map(bind_rows, .id = "status") %>% bind_rows(.id = "taxon") %>% na.omit() %>% filter(Sp1 != Sp2) %>% select(taxon, Sp1, Sp2, diet.match) %>% distinct() %>% group_by(taxon) %>% summarise(pairs = n(), related = length(which(diet.match == "Related")), pct_related = 100*related/n())

#no-turnover
 #shared <- tables %>% map(~.x %>% map(rownames) %>% reduce(match_val))
 #tables <- map2(tables, shared, function(x, y) map(x, function(z) return(z[y,])))

 #noturnover <- map(tables, map, ~expand.grid(Sp1 = rownames(.x), Sp2 = rownames(.x))) %>% map(map, diet_cat, spp, related = TRUE) %>%  map(bind_rows, .id = "status") %>% bind_rows(.id = "taxon") %>% na.omit() %>% filter(Sp1 != Sp2) %>% select(taxon, Sp1, Sp2, diet.match)   %>% distinct() %>% group_by(taxon) %>% summarise(related = length(which(diet.match == "Related")), pct_related = related/n())

```

To characterise the effect of food competition on community assembly, we consider every pairwise combination of species within each taxon (`r original %>% filter(taxon =="bat") %>% pull(pairs)` bat pairs and `r original %>% filter(taxon =="bird") %>% pull(pairs)` bird pairs). Dietary data are easily obtained for these two groups and widely used in large-scale studies. Each pair is classified as potentially competing (henceforth: competing) or not competing (henceforth: control) based on basic dietary guild data (Fig. 2). Competing pairs share dietary guilds while control pairs do not share any dietary sources. We excluded pairs with partially overlapping diets (`r original %>% filter(taxon =="bat") %>% pull(pct_related)`% of bat and `r original %>% filter(taxon =="bird") %>% pull(pct_related)`% of bird pairs) to produce the strongest possible test of our hypothesis that dietary relatedness should affect spatial association. 

The intersection of diet and habitat type produces four experimental groups: competing pairs in intact sites, non-competing pairs in intact sites, competing pairs in altered sites, and non-competing pairs in altered sites. We fit a hierarchical Bayesian model to estimate averages by group ($g$) for a spatial association parameter ($\bar{\theta_{g}}$, see Methods). A negative value of $\theta$ indicates spatial segregation or repulsion between members of species pairs, whereas a value of approximately 0 indicates independent patterns of occupancy for the pair and a positive value indicates spatial aggregation or attraction. We estimate $\bar{\theta_{g}}$ after first pooling the species pairs within each group into occupancy sets on the basis of shared occupancy values (e.g. all pairs with an occupancy pattern of {1,1} in one set, {1,2} in another set and so forth, see Fig. 2). This approach, which we term “occupancy-set analysis”, (see Methods), confers several advantages over classical “co-occurrence analysis”, which entails seperately assessing the spatial association for each species pair, or else calculating a single value for a complete matrix [@Arita2016]. Model results for competing pairs are compared to control pairs in each habitat for each taxon using 95% highest density intervals on 1,200 posterior samples (Fig 3, Extended Data Table 3). 

Though sharing diet guilds clearly does not guarantee that a species pair competes for food, this design ensures that — barring errors in guild assignment — all pairs that do compete for food are analysed in the same group. The inclusion of potentially many pairs that do not truly compete in this group reduces the power of the analysis and thus should produce conservative estimates of differences between groups. Because each species occurs in multiple pairs, and hence occupancy sets, the pairwise approach results in non-independence. Consequently, the significance of our results cannot be formally evaluated. Based on these two considerations, it is difficult to say whether the underlying effect is large in absolute terms. However, we report striking qualitative differences between independent habitat types that lend weight our analysis.

*Results and Discussion*

Overall, birds and bats both tend to aggregate ($\theta > 0$; Figs 3-4). This observation contradicts well-studied differences in the ecology of birds and bats. Bats exhibit limiting morphological similarity [@Kingston2000], share roosts [@Swift1983], display varied foraging behaviours [@Swift1983; @Denzinger2013], and micro-partition resources, habitats, and foraging times [@Aldridge1987], thus coexisting locally. By contrast, Neotropical bird species are well known for interspecific aggression [@Freeman2016a], separating out along elevational gradients [@Freeman2016a], and competitive exclusion [@Remsen1995]. Despite these differences, the average pairwise associations among species are generally positive for both taxa at the spatial scale of our analysis. The large spatial extent of this study means that biogeography likely plays a role in this outcome. There is compositional turnover in both taxa between Mexico and Argentina [@Alroy2019; @Kennedy2014], but nestedness of the community structure may also play a role.  

Competition for food affects the spatial community structure of both taxa, as demonstrated by offsets in the posterior distributions for $\bar{\theta_{g}}$ of competing and control groups (Fig. 3, Table S2). In intact habitats, we find no compelling evidence for assemblage-wide incidence of diet-based competitive exclusion (i.e., competing pairs co-occurring less than controls) in either taxon. The posterior distributions for $\bar{\theta_{g}}$ have higher modes for competing than control pairs, particularly among bats (Fig. 3), suggesting that spatial aggregation attributable to shared habitat preferences is of greater importance than any processes of competitive exclusion in structuring these communities. The variance of the $\theta$ estimates is also higher for competing pairs than control pairs (i.e., the distribution is wider and lower; see Extended Data Fig. 2), suggesting that mutual food sources encourage resource sharing and partitioning in the wild. 

In both taxa, this pattern changes in altered habitats. Specifically, the offset in $\bar{\theta_{g}}$ between competing and control pairs disappears in altered habitats. For birds, there is some evidence that $\bar{\theta_g}$ is lower for competing pairs than control pairs (Fig. 3). While aggregation may still occur in many pairs, exclusion is much more common for competing pairs under altered than intact conditions in both taxa. There is also a wholesale decrease in $\bar{\theta_g}$ in altered habitats for birds, so natural coexistence is less common in altered habitats, irrespective of overlap in resource requirements. 

To discover whether compositional differences between habitats are responsible for our results, we re-run our models while excluding species that are not sampled in both altered and intact habitats ("no-turnover" models). There is no qualitative change in the results for either bats or birds (Fig. 3). Taken together, these findings indicate that spatial associations among species differ between habitat types, and that this is not simply due to compositional differences between habitat types (e.g., some species occurring only in intact habitats or vice versa). 

*Conclusion*

We find positive average associations among bat and bird species in intact habitats. However, for both taxa, there was greater coexistence for competing pairs than expected, suggesting that resource partitioning occurs more frequently than competitive exclusion when species pairs share resource requirements. This pattern changes in altered habitats. Altered habitats afford fewer opportunities for the coexistence of birds more generally. Competing pairs, however, exhibit equal or lower coexistence than control pairs under altered conditions, suggesting that competitive exclusion is more common. Thus, altered habitats are unable to consistently support varied local communities of competing species through niche and resource partitioning to the same level that intact habitats do. The no-turnover analyses indicate that these effects are largely attributable to changes in species spatial distributions with respect to their interaction partners, and not merely to differences in species composition.

Our results bring new evidence to the hotly debated effect of resource overlap on bird co-occurrence. A long history of studies argues that competitive exclusion detectable by distribution patterns alone [@Diamond1975; @Gilpin1982; @Sanderson2009] is a common phenomenon in bird pairs that share dietary guilds [@Diamond1982] or are closely related [@Gilpin1982]. The opposing viewpoint holds that bird pairs have statistically weak spatial associations which cannot be used to infer the effects of competition [@Connor1979; @Gotelli2002; @Sfenthourakis2005] or at best, associations with mundane geographical explanations, rather than biological ones [@Connor2013]. 

However, all of these studies used classic approaches to co-occurrence analysis that consider each species pair in isolation, leaving inadequate statistical power to assess spatial associations among relatively rare taxa, which generally comprise the vast majority of species. Factors leading to positive spatial associations are seldom discussed at any length and are often chalked up to mere similarity of habitat preferences or matching geographical origins of these pairs [@Connor2013]. However, Gilpin and Diamond [@Gilpin1982] mentioned that myriad similar bird species are seen to co-occur due to offsets in space utilization, specific diets, or foraging strategies. Our results supply evidence that this is more common in species with resource overlap than those without, hinting that competition may have driven the evolution of these relationships [@Gilpin1982]. Moreover, our analysis shows that the effects of resource overlap can indeed be detected by using occurrence data alone when using a proper control group as a benchmark for comparison, and further suggest that similar mechanisms may operate for a functionally similar taxon (bats).

Overall, habitat alteration reduces and may even reverse the effect of competition on community structure in both bats and birds. Our results add to mounting evidence that human activity changes community structure and interactions without necessarily adding or removing species, and further corroborates that this can play out over landscape scales. Though diversity loss is known to influence ecosystem services [@Winfree2018], analogous studies examining the relationships between ecological interactions and functionality of ecosystems are rare (but see e.g. Ref. [@Cardinale2002]). Consequences of shifting competition outcomes are therefore poorly understood, but detrimental scenarios are easy to envision. For example, population control of a destructive pest by a competing species cannot take place if the two species are unable to coexist. Our results shed light on the relationship between ecological interactions and regional community assembly, and our approach helps pave the way for future research seeking to understand how interaction outcomes change across various contexts and at large spatial scales.

__Main Text References:__

*copy in from bottom*

__Figures:__

```{r echo=FALSE, fig.height=4, fig.width=9, message=FALSE, warning=FALSE, include=T}

# Ordination
dist <- PAn %>% tobinary() %>% map(as.matrix) %>% map(cosine) %>% map(as.dist, upper = F) %>% map(~return(1-.))
#dist <- map(PA, ~t(.)) %>% map(vegdist, method = "bray")
ord <- map(dist, cmdscale, k = 2) %>% map(data.frame)
ord <- map(ord, ~merge(., y = sitedat, all.x = T, all.y = F, by.x = 0, by.y = "p.sample") %>% mutate(status = ifelse(status == "Unaltered", "Intact", "Altered")))

bat <- image_read("bat_pic.png") %>% image_fill('none') %>% as.raster()
bird <- image_read("bird_pic.png") %>% image_fill('none') %>% as.raster()

#PCoA plot
  p1 <- ggplot(ord[[1]], aes(x = X1, y = X2, col = status)) + geom_point(size = 2.6) + labs(x = "PCoA 1", y = "PCoA 2", col = "alteration") + theme(axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title =  element_text(size = 12, face = "bold")) + labs(col = "status") + scale_colour_manual(values = c("#DF8768", "#006D77")) +
    annotation_raster(bat, -0.45, -0.2, 0.27, 0.42)#+ geom_point(aes(x = mean(X1), y = mean(X2), col = status), pch = 3, size = 3)
  
  p2 <- ggplot(ord[[2]], aes(x = X1, y = X2, col = status)) + geom_point(size = 2.6) + labs(x = "PCoA 1", y = "PCoA 2", col = "alteration") + theme(axis.text = element_text(size = 12)) + labs(col = "status") + scale_colour_manual(values = c("#DF8768", "#006D77"), labels = c("Altered", "Intact")) +
     annotation_raster(bird, -0.45, -0.25, 0.25, 0.44) #+ geom_point(aes(x = mean(X1), y = mean(X2), col = status), pch = 3, size = 3)
  
  p <- plot_grid(p1+theme(legend.position = "none"), 
                 p2+theme(legend.position = "none", 
                axis.title.y = element_blank()), ncol = 2, labels = c("A","B"), align = "lr")
  plot_grid(p, get_legend(p1), rel_widths = c(1, .2))

```

__Figure 1.__ Bat and bird and community structure. Metric multidimensional scaling analysis of altered and intact sites for (A) bats and (B) birds based on the Otsuka-Ochiai dissimilarity index [@Hubalek1982].

![](../../Figures/Fig2_concept_v3.png) 

__Figure 2.__ Conceptual figure demonstrating the experimental design. (A) Pairwise combinations of species are depicted using an adjacency matrix, with black squares representing granivores and yellow squares representing nectarivores. White numbers along the top and left side of the adjacency matrix are the occupancies $N_A$ and $N_B$ (i.e., numbers of occupied sites) for species A and B, respectively. Species pairs within the adjacency matrix are assigned to one of four groups (g) on the basis of habitat (altered or intact) and dietary guild overlap (competing or control, denoted by blue and gray cells, respectively). Pairs within groups are then subdivided into _occupancy sets_ on the basis of shared occupancy values (black paired numbers, calculated as {$\text{min}(N_A, N_B), \text{max}(N_A, N_B)$}). (B) Estimates of spatial association, $\theta_i$, are calculated for each occupancy set. (C) The $\theta_i$ values are then averaged for each group, yielding posterior distributions for $\bar{\theta_g}$ for each group, $\bar{\theta_{g}}$. Estimates are calculated separately for altered and intact sites and then compared.

```{r echo=FALSE, fig.height=7, fig.width=4, message=FALSE, warning=FALSE, include=T}
library(ggridges)
bat_full <- readRDS("../Results/stan/stan6_bats_all_full.rds")
bat_noTurnover <- readRDS("../Results/stan/stan6_bats_all_shared.rds")
bird_full <- readRDS("../Results/stan/stan6_birds_all_full.rds")
bird_noTurnover <- readRDS("../Results/stan/stan6_birds_all_shared.rds")

out <- list(bat_full = bat_full, 
            bat_noTurnover = bat_noTurnover, 
            bird_full = bird_full, 
            bird_noTurnover = bird_noTurnover)

p <- map(out, ~format_stanfit(.x)) %>% bind_rows(.id = "taxon_model") %>%
  separate(taxon_model, c("taxon", "model"))

ggplot(p, aes(x = mu, y = status, col = interaction, fill = interaction)) + 
      geom_density_ridges(lwd = 1, alpha = 0.4, rel_min_height = 0.001) +
      facet_grid(taxon+model~.) +
      scale_y_discrete(expand = c(0,0)) +
      coord_cartesian(clip = "off") +
      scale_color_manual(values = c("#045FB4", "#2E2E2E")) +
      scale_fill_manual(values = c("#045FB4", "#2E2E2E")) + 
      labs(x = expression(group~theta), y = element_blank()) + 
      theme_ridges() + theme(legend.position = "bottom")


```

__Figure 3.__ Posterior distributions of $\bar{\theta_{g}}$ for bat and bird models. Models that contained all species (full) and those containing only species that occurred in both altered and intact habitat types (no-turnover) are depicted in adjacent panels.


__Methods:__

_Data_ 

Abundance data, site metadata (including habitat alteration status) and species dietary data for Neotropical bats and birds were downloaded from Ecological Register (http://ecoregister.org). We describe the dataset and our data preparation procedure in detail in the supplement. Our cleaned dataset had `r sum(tobinary.single(PAn[["bat"]]))` occurrences of bats and `r sum(tobinary.single(PAn[["bird"]]))` occurrences of birds at `r ncol(PAn[["bat"]])` and `r ncol(PAn[["bird"]])` sites, respectively. The original and final sites included in the analysis are plotted in Extended Data Fig. 1.

_Richness_ 

We estimate richness for bats and birds in altered and intact sites using three diversity metrics: a corrected first-order jackknife (cJ1) [@Alroy2020], the canonical Chao1 [@Chao1984], and Fisher’s alpha, which is robust to sample size, widely used, and well-grounded in theory [@Schulte2005]. Each metric is applied to the raw abundance data for all sites. We compare richness estimates between altered and intact sites for both taxa using Wilcoxon rank-sum tests. 

_Beta diversity and species composition_ 

We compare the beta diversity and species composition of altered and intact sites using a suite of classical analyses. We estimate beta-diversity differences between two groups of samples using a multivariate dispersion test [@Anderson2006], implemented using the *betadisper* function in the R package *vegan* [@Oksanen2008]. We also compare the composition of altered and intact sites for both taxa with permutational multivariate ANOVA using *adonis* [@Anderson2001] and canonical correspondence analysis using *cca* [@Legendre2012], also from the *vegan* package. Multivariate dispersion and permutational ANOVA require a distance metric, and the choice of distance metric may influence the results. We therefore run these analyses using the relatively ubiquitous Jaccard index [@Hubalek1982] and again with the Otsuka-Ochiai index [@Hubalek1982]. Beta diversity and composition can be compared based on abundance data or occurrence data, noting that the Otsuka-Ochiai index is equivalent to cosine similarity when run on abundance data. We run our analyses with both data types, but we focus on the results obtained with occurrence data, as these are much more common and easily obtained. However, we note cases where results from abundance data differ quantitatively.

_Biotic interactions_ 

To explore the effect of interactions on the spatial association of species, we use a combination of novel and existing methods. First, we revive the seldom-used practice of comparing spatial associations between groups of species pairs where one group acts as a control. This approach allows us to isolate the effect of interactions from other confounding variables and has been used e.g, to examine how closely related species associate compared to pairs that are not related [@Sanderson2009]. Previous research, however, has almost exclusively used co-occurrence metrics that evaluate the departure of species pairs’ spatial patterns from random expectations. We recognize here, however, that under a comparative approach, a metric is needed that directly quantifies the magnitude and direction of spatial association for a species pair. The fitted parameter, $\theta$, of Fisher’s noncentral hypergeometric distribution (NHD) has these attributes (see Eq. 1c below), and therefore serves as our pairwise association metric. To our knowledge, our study is the first to use the NHD to analyse co-occurrence data. Finally, we introduce a novel methodology to estimate $\theta$, termed “occupancy-set analysis”, that entails aggregating pairs into occupancy sets defined based on the numbers of sites occupied by the two species, {$\text{min}(N_A, N_B), \text{max}(N_A, N_B)$} (see Fig. 2). We implement occupancy-set analysis using a hierarchical Bayesian model that estimates the underlying average spatial association for species-pair groups defined based on habitat (altered or intact) and dietary guild overlap (competing or control). The details of these methods follow.

_Species pair groups_

We used dietary information for bats and birds from the Ecological Register to infer the effects of food competition on spatial associations. We selected all pairs with complete dietary information and classified them as competing or control. Competing pairs shared primary and secondary sources of food, but we allowed the order of these to be reversed (e.g., a frugivore-nectarivore and a nectarivore-frugivore would be equated). Control pairs had no mutual food sources and presumably do not compete for food. Pairs with mutual and nonmutual food sources (e.g., a frugivore and an insectivore-frugivore) may experience a complex mix of effects (e.g. spatial or environmental variation in degree of resource overlap), and were therefore removed from the analysis for simplicity (`r original %>% filter(taxon == "bat") %>% pull(related)` or `r original %>% filter(taxon == "bat") %>% pull(pct_related)`% of bat pairs and `r original %>% filter(taxon == "bird") %>% pull(related)` or `r original %>% filter(taxon == "bird") %>% pull(pct_related)`% of bird pairs fell into this category). Although species in the same dietary guilds do not necessarily compete, pairs with high dietary overlap have a nonzero probability of experiencing competition for food, while pairs in differing guilds have no chance of competing for food if the categorizations are accurate. Therefore, the co-occurrence patterns of competing and non-competing groups should be different if food competition plays a role in structuring a given assemblage.

Recent studies repeatedly point out that nonrandom co-occurrence should not be construed as evidence for interaction between species pairs [@Freilich2018;@Thurman2019; @Blanchet2020]. In our framework, we have independent evidence of potential interactions (diet) and examine the relationship between putative interactions and co-occurrence, using non-competing pairs as a control. Controls are rarely used in co-occurrence research, with most studies preferring to discard pairs with associations that are not seen as significant (e.g., Refs. [@Araujo2011; @Lyons2016]). Research using using a control set of pairs to factor out confounding variables can help us to understand under what circumstances, and to what extent, interactions lead to nonrandom spatial associations and how they change under shifting external conditions.

_Fisher's noncentral hypergeometric distribution_

We assume that the number of sites of co-occurrence, $N_{AB}$, for a given pair of species, A and B, adheres to Fisher's noncentral hypergeometric distribution (NHD) [@Fog2008],

\[
f(N_{AB}|\theta) = 
\frac{{N_{A} \choose N_{AB}}{N_{(A)}\choose N_{B} - N_{AB}} \text{exp}(N_{AB}\theta) }
{P_{0}(\theta)} 
\]


where $N_{A}$ and $N_{(A)}$ are the respective numbers of sites with species A
present and absent, $N_{A} + N_{(A)}$ is the total number of sites, $N_{B}$ is
the number of sites with species B present, and $\binom{n}{k} = n!/k!/(n-k)!$ is a binomial coefficient. The numerator of this probability mass function represents the number of ways that two species can achieve $N_{AB}$ co-occurrences given fixed values for the two species' occupancies ($N_A$ and $N_B$) and the total number of sites ($N_A + N_{(A)}$). The denominator, $P_0(\theta)$, is the total number of possible spatial configurations for the species pair given $N_A$, $N_{(A)}$, and $N_B$. It is therefore calculated by summing the quantity calculated in the numerator over all possible $N_{AB}$ values [@McCullagh1952], from $\text{max}(0, N_B - N_{(A)})$ to $\text{min}(N_A, N_B)$. We characterise this quantity using a more general expression, 

\[
P_{k}(\theta) = {\sum^{min(N_{A}, N_{B})} _{n = max(0, N_{B}-N_{(A)})} {N_{A}\choose n} {N_{(A)}\choose N_{B} - n} \text{exp}(n\theta)n^k}
\]

with k=0, because $P_k(\theta)$ yields compact expressions for subsequent steps of the derivation presented in the supplement. The NHD has one fitted parameter,

\[
\theta = log(\psi) = 
\log \left( \frac {\pi_{B\mid A}}{\pi_{B \mid (A)}} \right) = 
\log \left(\frac {p_{B\mid A}(1-p_{B\mid (A)})}{(1-p_{B \mid A})p_{B\mid(A)}} \right)
\]

which is the logarithm of an odds ratio $\psi = \pi_{B|A}/\pi_{B|(A)}$, where
$\pi_{B|A}$ and $p_{B|A}$ are the respective odds and probability that species B
occupies a site given that species A is present, and $\pi_{B|(A)}$ and $p_{B|(A)}$ are the respective odds and probability that species B occupies a site given that species A is absent. The value of $\theta$, and the probability of having $N_{AB}$ co-occurrences given $\theta$, $f(N_{AB}|\theta)$, are both independent of which member of the species pair is arbitrarily chosen as species A. The NHD is typically parameterised using $\psi$ rather than $\theta$, but $\psi$ has a lower bound of 0, making it less convenient for model fitting and biological interpretation.

The NHD parameter $\theta$ directly quantifies spatial patterns of co-occurrence
for a species pair. If $\theta < 0$, species B is less likely to occur at a site if species A is present, as we would expect if there was competitive exclusion or
differences in habitat preferences between the two species. If $\theta>0$, species B is more likely to occur at a site if species A is present, as we would expect if the species shared habitat preferences and did not competitively exclude each other. Finally, if $\theta = 0$, the two taxa are independently distributed. When $\theta = 0$, the NHD reduces to the standard (i.e., centered)
hypergeometric distribution, which has frequently been used as a null model to evaluate whether patterns of co-occurrence differ from random [@Arita2016]. To our knowledge, our study is the first to use the noncentral form of the
hypergeometric distribution for co-occurrence analyses. 

In light of the rich array of methodologies already available for quantifying species associations, the use of the NHD parameter $\theta$ as a co-occurrence metric must be justified. First, while $\theta$ is mathematically related to existing co-occurrence metrics (e.g., the mid-P variant of Fisher's Exact Test [@Keil2021]), it fundamentally differs in that it is not based on a null model. Instead, $\theta$ directly quantifies the magnitude of the effect of one species' presence on the occurrence probability of another (analogous to the distinction between a correlation measure of effect size, _r_, and a p-value calculated under the null hypothesis that _r_ = 0). Thus, $\theta$ is biologically interpretable (Eq. 1c), it is directly comparable between pairs, and it is easily programmable. Finally, $\theta$ is not sensitive to the number of sites in the study assemblage, making formal comparisons and meta-analyses possible down the track. Because existing co-occurrence methods are not commensurate with our approach, we do not attempt to draw any direct comparisons. However, we perform a series of analyses to demonstrate the behaviour of the NHD parameter and evaluate its ability to quantify spatial associations between species (see supplement).

_Occupancy-set analysis_

Our analysis on the performance of $\theta$ (supplement) highlights three general issues that arise when fitting the NHD to occurrence data:

(i)  A non-overlapping pair (i.e., $N_{AB} = 0$) will be observed with
higher probability for a species pair with lower occurrence values ($N_{A}$ and
$N_{B}$), irrespective of $\theta$.

(ii)  A _single_ observation of a non-overlapping pair will not _by itself_ be biologically informative about the value of $\theta$ (i.e., the maximum likelihood estimate $\hat{\theta}=-\infty$).

(iii) The amount of information about $\theta$ that can be inferred from a _single_ observation is generally lower for a species pair with lower occurrence values.

In other words, the parameter $\theta$ suffers from similar constraints as most existing metrics of species association, which attempt to leverage biological information from pairwise occurrence data. These constraints are seldom considered explicitly in published co-occurrence analyses, aside from throwing out pairs that do not yield biological information by themselves. 

To address these three issues, we present a novel approach, which we term "occupancy-set analysis". Rather than separately estimate $\theta$ for each species pair, $j$, based on the number of co-occurrences for that pair, $N_{AB}^j$, we instead _combine_ observations for pairs grouped into occupancy sets, $\mathcal{S}_{i}$, defined for pairs $j∈ \mathcal{S}_{i}$ on the basis of shared occupancy values, {min($N_{A}$, $N_{B}$), max($N_{A}$, $N_{B}$)} (see Fig. 2). We then calculate the likelihood for each occupancy set based on a single $\theta$ value, $\theta_{i}$, under the explicit assumption that every pair in the set has the same $\theta$ value. This likelihood, 

\[
\mathcal{L}(\theta_{i}∣\boldsymbol{N_{AB}^i}) = \prod_{j \in \mathcal{S}_i} f(N_{AB}^j|\theta_i)
\]


is simply the product of the likelihoods for the co-occurrence observations in the occupancy set, $\boldsymbol{N_{AB}^{i}} = \{N_{AB}^{j} | j∈ \mathcal{S}_i\}$. This approach partly addresses issues (*i*) and (*ii*) because $N_{AB} = 0$ is less likely to be observed for an entire set of observations than a single
observation, and the maximum likelihood estimate for $\theta_i$ will be finite
provided that at least one observation in the occupancy set is not an edge case (i.e.,$N_{AB} >\max(0,N_{B}-N_{(A)})$ and $N_{AB} <\min(N_{A},N_{B})$). It also addresses issue (*iii*) because the Fisher Information is additive [@Ly2017],
meaning that it increases linearly with the number of observations. As an added benefit, performing likelihood calculations on occupancy sets reduces the time required for model fitting by orders of magnitude as compared to separately estimating $\theta$ for each pair. 

_Specifying the model_

To further address issues (*i*) and (*ii*), we adopt a hierarchical Bayesian modeling
approach [@Gelman2014] to estimate averages for $\theta_i$ that have been subdivided into four groups, $g$, based on habitat type (altered, intact) and diet (competing, control). At the lower (i.e., occupancy-set) level, we assume that the $\theta_i$ values
are all normally distributed with means and standard deviations that can vary
among groups

\[
\theta_i \sim \mathcal{N}(\overline{\theta}_{g(i)}, \sigma_{g(i)})
\]


where $g(i)$ is a function that indexes the group assignment of each set. At the
upper (i.e., community) level, we assign the group means, $\overline{\theta}_g$,
a normal prior distribution with a mean of 0 and a standard deviation of 10,

\[
\overline{\theta}_g \sim \mathcal{N}(0, 10)
\]


and we assign the group standard deviations, $\sigma_{g}$, a half-normal prior
distribution with location and scale parameters of 0 and 10, respectively, on
the interval $[0,\infty]$,

\[
\sigma_{g} \sim \mathcal{H}(0, 10)
\]

These prior distributions were chosen to allow adequate exploration of the
parameter space using the Markov chain Monte Carlo (MCMC) algorithm while
ensuring that the algorithm never halted by getting stuck in regions of
parameter space with negligible likelihood. These prior distributions should be
viewed as very weakly informative in the parlance of Bayesian analysis [@Lemoine2019].

Our implementation of occupancy-set analysis within a hierarchical Bayesian modelling framework confers three major advantages over previous approaches when calculating spatial associations for assemblages. First, by treating the occupancy set as the experimental unit, it can extract more information about pairwise spatial associations from the co-occurrence data than analyses that treat the pair as the experimental unit, yielding more robust inferences. Second, the algorithm is formulated in such a way that adding species does not appreciably increase the computing time of the model, meaning hyper-diverse datasets for which co-occurrence analysis is not feasible can be analysed using occupancy-set analysis. Finally, the hierarchical approach ensures that sets of pairs yielding weaker evidence (as indexed by smaller likelihoods) exhibit greater shrinkage toward the mean (see supplement), and sets yielding stronger evidence are assigned greater weight in calculating the group-level means and standard deviations.

_Fitting the model_

We estimate the posterior distributions using the R package RStan, which
provides an interface from R to the Stan probabilistic programming language [@StanDevelopmentTeam2022]. To approximate the posterior distributions, we generate 4 MCMC chains of 2000 steps, including a warm-up period of 1000 steps. We then inspect MCMC plots for the 4 chains and calculated Gelman Rubin statistics, to ensure convergence [@Gelman2014]. We run a series of robustness checks that ensure our model is not subject to several common biases (see supplement).

_Model interpretation_

In this framework, a change in the posterior distributions of $\overline{\theta_g}$ can point to various biological processes (Extended Data Fig. 2). Competing pairs can display lower $\overline{\theta_g}$ than non-competing pairs, which means that diffuse competition tends to lead to exclusion at some sites with respect to opportunity for co-occurrence (Extended Data Fig. 2A). This is the case even if all $\overline{\theta_g}$ are positive, as exclusion does not necessarily present as a negative association. Specifically, because competing and non-competing pairs are comprised of the same presence-absence data in different pairwise arrangements, the $\overline{\theta_g}$ of non-competing pairs represents the opportunity for coexistence in the absence of food competition and controls for the effects of all confounding variables (e.g biogeography, other types of interactions, etc.). A deviation toward lower $\overline{\theta_g}$ from this baseline is evidence that competing pairs are not coexisting as often as expected--a systematic pattern of exclusion at the group level. Conversely, a higher $\overline{\theta_g}$ in competing pairs confirms that similarity in resource use leads to coexistence, suggesting that competing pairs have adapted to partition resources (Extended Data Fig. 2B). If the $\overline{\theta_g}$ of competing and non-competing pairs do not differ significantly, but the $\sigma_{g}$ (variance) of competing pairs is higher, this points to stronger spatial patterns (both coexistence and exclusion) in pairs that compete for food, and vice versa (Extended Data Fig. 2D). If there is no difference in $\overline{\theta_g}$ or $\sigma_{g}$ between the two groups, then there is insufficient evidence to support the hypothesis that diffuse competition is influencing the structure of the assemblage at the landscape scale (Extended Data Fig. 2C).

The $\overline{\theta_g}$ and $\sigma_{g}$ of competing and non-competing pairs might also differ between altered and intact sites in our example. If the relationship between competing and non-competing pairs is different, this means that alteration has changed the outcome of biotic interactions, e.g., by promoting partitioning over exclusion or vice versa. More subtly, the extent of disparity between the two groups could differ without qualitatively changing the relationship, which indicates that naturally existing mechanisms have been enhanced or dampened. On the other hand, $\overline{\theta_g}$ or $\sigma_{g}$ could simply be higher or lower across the board, suggesting that alteration leads to changes in community structure that do not necessarily involve the rewiring of competitive interactions. In all cases, posteriors represent assemblage-level patterns and do not imply that all pairs in the group exhibit the same pattern as does their group, merely that there is a group tendency toward one process over another.

The experimental approach presented here represents two distinct innovations that allow us to deal with detection issues and context-dependence of interactions. First, we use a priori evidence for the possibility of interaction rather than direct interaction data. The resulting set of pairs includes both interacting and non-interacting pairs but encompasses all of the former. A priori evidence for many types of interactions could be derived from various functional traits. For example, fruit size and gape size of frugivorous birds can indicate which birds are physically able to disperse which fruits. Diet category and body size can similarly be used to estimate mammal predator-prey relationships [@Pires2015]. This setup frees us from the necessity of manually observing all interactions and identifying the contexts under which they are realised while yielding broad insights about the impact of interactions on community assembly.

Second, we use non-interacting pairs of species in the assemblage to contextualise association patterns for interacting species pairs. The inclusion of an experimental control group is a central tenet of science, but non-interacting pairs or those having associations not significantly different from chance associations are routinely discarded or ignored in co-occurrence research and interaction research more generally, while raw pairwise co-occurrence scores are often interpreted at face value (e.g., any negative score equals exclusion). Our use of non-interacting pairs as a control can be applied to a broad variety of interactions. A plant-pollinator network could for instance be decomposed into groups of pairs that facilitate one another (plant-pollinator pairs), do not interact, and even compete (plant-plant pairs that compete for pollinators or pollinator-pollinator pairs that compete for nectar). In each case, the effect of the competing group(s) can be evaluated against all pairs that do not exhibit the interaction(s) in question.

_The effect of turnover_

Overall changes observed in association patterns could result from pairs changing their spatial relationships or their competition intensity in altered vs. intact habitats. Conversely, a shift in species composition (e.g., the removal or introduction of interaction partners), and therefore the presence of a different suite of pairs, could also cause disparities between the two habitat types. To investigate these possibilities, we ran the models with all species and then repeated them with only species occurring at least once in both habitat types ("no-turnover" models). If the results of the two model sets are very similar, we can conclude that the results are driven by changes in the spatial relationships of species occurring in both site types. If the two model sets are different but both show differences between groups, likely both turnover and changes in preserved interactions are occurring. Furthermore, the differences between the two outputs can be used to determine which changes are due to which mechanism. Model effects are due to turnover alone if the model set using only shared species has no differences while the model set using all species does.

_Data and code availability_  All R workflows and cleaned datasets used for this analysis are available at https://github.com/anikobtoth/HabitatAlteration.


__Method References:__
*copy in from bottom*


__Acknowledgments:__ We thank the Macquarie University paleobiology lab for discussions that improved this paper. ABT was partially supported by an IMQRES scholarship at Macquarie University.

__Author contributions:__ ABT and JA designed the study, JA curated the data, JA and APA provided statistical expertise, ABT analysed data, produced the figures, and wrote the paper. ABT and APA designed, coded, and tested the model. SKL helped design supporting analyses. All authors edited the manuscript.

__Competing Interests:__ The authors declare no competing interests.

__Additional Information:__

Supplementary Information is available for this paper.
Correspondence and requests for materials should be addressed to Dr. Anikó B. Tóth at aniko.toth@unsw.edu.au.
Reprints and permissions information is available at www.nature.com/reprints.

__Extended Data:__
```{r setup2, include=FALSE}

## Load stan functions
source('../Code/stan.R')

library(flextable)
library(bayestestR)
library(lsa)
library(plotrix)
```

```{r edf1, echo = FALSE, include = TRUE, fig.height=5.5, fig.width = 7}
#load("../Data/coords.Rdata")

### FIGURE S1: Maps ####
par(mfrow = c(2,2), mar = c(0,0,0,0), oma = c(1,1,1,1))

maps::map("world", xlim = c(-125, -30), ylim = c(-40, 25))
points(latitude~longitude, coords1$bat, pch = 16, cex=.7, col = "#006D77")
points(latitude~longitude, coords2$bat, pch = 16, cex=.7, col = "#DF8768")
mtext("Bats-original sites", side = 3, line = 1)
box()

maps::map("world", xlim = c(-125, -30), ylim = c(-40, 25))
points(latitude~longitude, coords1$bird, pch = 16, cex=.7, col = "#006D77")
points(latitude~longitude, coords2$bird, pch = 16, cex=.7, col = "#DF8768")
mtext("Birds-original sites", side = 3, line = 1)
box()

maps::map("world", xlim = c(-125, -30), ylim = c(-40, 25))
points(latitude~longitude, coords1.keep$bat, pch = 16, cex=.7, col = "#006D77")
points(latitude~longitude, coords2.keep$bat, pch = 16, cex=.7, col = "#DF8768")
mtext("Bats-included sites", side = 3, line = 1)
box()

maps::map("world", xlim = c(-125, -30), ylim = c(-40, 25))
points(latitude~longitude, coords1.keep$bird, pch = 16, cex=.7, col = "#006D77")
points(latitude~longitude, coords2.keep$bird, pch = 16, cex=.7, col = "#DF8768")
mtext("Birds-included sites", side = 3, line = 1)
box()


```

__Extended Data Fig. 1__ 
Maps of Neotropical bat and bird sites before (top) and after (bottom) biogeographic matching procedure, with altered sites represented in beige and intact sites represented in teal.

![](../../Figures/FigS8.png) 

__Extended Data Fig. 2__ Interpretations of average $\overline{\theta_g}$ posterior density distributions. The dark curve indicates competing pairs and the lighter curve indicates control pairs. In (A) competing pairs co-occur less on average than control pairs, so higher spatial segregation than expected suggesting a pattern of competitive exclusion. In (B) competing pairs co-occur more than control pairs on average, suggesting that they micro-partition resources at the same sites more than expected. In (C) there is little or no separation of the posterior distributions, meaning that food competition does not aggregate or segregate pairs outside of expectations; however, other interaction types could still play an important role. (D) Both strong aggregation and segregation are observed in competing pairs, so variance is higher than expected.


```{r edf2, echo=FALSE, include = TRUE, message=FALSE, warning=FALSE, dpi=200}
library(scales)

log_sum_exp <- function(x) log(sum(exp(x - max(x)))) + max(x)
fnchypergeo_lpmf <- function(sb, s1, s2, n_site, theta) {
  sb_min <- max(c(0,s1 + s2 - n_site))
  sb_max <- min(c(s1,s2))
  u <- ll <- ans <- numeric()
  for(i in sb_min:sb_max) {
    u[i - sb_min + 1] = i;
    ll[i - sb_min + 1] = lchoose(s1, i) + lchoose(n_site - s1, s2 - i)
  }
  if(length(sb) > 1) {
    for(i in 1:length(sb)) {
      ans[i] = ll[sb[i] - sb_min + 1] + sb[i]*theta - log_sum_exp(ll + u*theta)
    }
  } else {
    for(i in 1:length(theta)) {
      ans[i] = ll[sb - sb_min + 1] + sb*theta[i] - log_sum_exp(ll + u*theta[i])
    }
  }    
  return(ans)
}


ll_plot <- function(s1, s2, n_site, theta,...) {
  sb_min <- max(c(0,s1 + s2 - n_site))
  sb_max <- min(c(s1,s2))
  x <- sb_min:sb_max
  y <- fnchypergeo_lpmf(sb_min:sb_max, s1, s2, n_site, theta)
  lines(x,y,lwd=1.8,type='o',pch=16,cex=0.5,...)
}

my.cols <- c('red','blue')
plot(0,0,xlim=c(0,9),ylim=c(-7,0),type='n',
     xlab=expression("Number of co-occurrences,"~italic(N[AB])),
     ylab = expression("Probability,"~italic(f)(italic(N[AB])~"|"~italic("\u03B8"))),
     axes=FALSE)
axis(1,at=0:9,labels=0:9)
axis(2,at=log(10^seq(-3,0,1)),labels=parse(text=paste0('10^{',seq(-3,0,1),'}')),
     las=1)
box()
ll_plot(2,2,50,-2,col=alpha(my.cols[1],0.5),lty=3) 
ll_plot(2,2,50,0,col=alpha(my.cols[1],0.5),lty=2)
ll_plot(2,2,50,2,col=alpha(my.cols[1],0.5),lty=1)
ll_plot(8,8,50,-2,col=alpha(my.cols[2],0.5),lty=3) 
ll_plot(8,8,50,0,col=alpha(my.cols[2],0.5),lty=2)
ll_plot(8,8,50,2,col=alpha(my.cols[2],0.5),lty=1)
legend('topright',bty='n',lwd=1.8,
       legend=expression(italic("\u03B8")~"="~-2,
                         italic("\u03B8")~"="~0,
                         italic("\u03B8")~"="~2,'',
                         italic(N[A])~"="~italic(N[B])~"="~2,
                         italic(N[A])~"="~italic(N[B])~"="~8),
       lty=c(3,2,1,0,1,1),
       col=c(rep('black',4),my.cols))
```

__Extended Data Fig. 3__ 
Performance of $\theta$. Effects of species occurrence (indexed by $N_{A}$ and $N_{B}$) and spatial aggregation ($\theta > 0$) and segregation ($\theta < 0$) on the probability distribution of co-occurrences. Probabilities were calculated using Eq. 1 based on a total of $N_{A} + N_{(A)}=50$ sites.


```{r edf3, dpi=200, include = TRUE, echo=FALSE}
log_sum_exp <- function(x) log(sum(exp(x - max(x)))) + max(x)
fnchypergeo_FI <- function(s1, s2, n_site, theta) {
  sb_min <- max(c(0,s1 + s2 - n_site))
  sb_max <- min(c(s1,s2))
  ans<- numeric()
  u <- ll <- ans <- numeric()
  for(i in sb_min:sb_max) {
    u[i - sb_min + 1] = i;
    ll[i - sb_min + 1] = lchoose(s1, i) + lchoose(n_site - s1, s2 - i)
  }
  for(i in 1:length(theta)) {
    ans[i] <-
      exp(log_sum_exp(2*log(u) + ll + u*theta[i])-log_sum_exp(ll + u*theta[i])) - 
      exp(log_sum_exp(log(u) + ll + u*theta[i])-log_sum_exp(ll + u*theta[i]))^2
  }
  return(ans)
}

o.sq <- seq(-10,10,.01)
plot(o.sq,fnchypergeo_FI(2, 2, 50, o.sq),las=1,
     xlab=expression("NHD Parameter, "~italic("\u03B8")),type='l',ylim=c(0,3),
     ylab=expression("Fisher Information, "~italic(I)(italic("\u03B8"))),
     col=hcl.colors(5)[1],lwd=1.5)
lines(o.sq,fnchypergeo_FI(2, 8, 50, o.sq),
      lty=2,col=hcl.colors(5)[1],lwd=1.5)
lines(o.sq,fnchypergeo_FI(8, 8, 50, o.sq),
      lty=3,col=hcl.colors(5)[2],lwd=1.5)
lines(o.sq,fnchypergeo_FI(8, 16, 50, o.sq),
      lty=4,col=hcl.colors(5)[2],lwd=1.5)
lines(o.sq,fnchypergeo_FI(16, 16, 50, o.sq),
      lty=5,col=hcl.colors(5)[3],lwd=1.5)
lines(o.sq,fnchypergeo_FI(32, 32, 50, o.sq),
      lty=6,col=hcl.colors(5)[4],lwd=1.5)
lines(o.sq,fnchypergeo_FI(40, 40, 50, o.sq),
      lty=7,col=hcl.colors(5)[5],lwd=1.5)
legend('topleft',legend=expression(italic(N[A])~"="~italic(N[B])~"="~2,
                                   italic(N[A])~"="~2~", "~italic(N[B])~"="~8,
                                   italic(N[A])~"="~italic(N[B])~"="~8,
                                   italic(N[A])~"="~8~", "~italic(N[B])~"="~16,
                                   italic(N[A])~"="~italic(N[B])~"="~16,
                                   italic(N[A])~"="~italic(N[B])~"="~32,
                                   italic(N[A])~"="~italic(N[B])~"="~40),
       lty=1:7,bty='n',col=hcl.colors(5)[c(1,1,2,2,3,4,5)],lwd=1.5,cex=0.75)
```

__Extended Data Fig. 4__
Fisher information of varying occupancy pairs. Effects of occupancy ($N_{A}$ and $N_{B}$) and spatial aggregation ($\theta$) on the probability distribution of co-occurrences. Probabilities were calculated using Eq. S2, assuming a total of $N_{A} + N_{(A)}=50$ sites.

```{r edf4, echo = FALSE, include = TRUE, fig.height=6, fig.width = 7, dpi = 200}
par(mfrow = c(2,2))
data_bat_full <- readRDS("../Results/stan/Model_data_bats_all_full.rds")
bat_full <- readRDS("../Results/stan/stan6_bats_all_full.rds")
ml_bat_full <- readRDS("../Results/stan/ML_bats_all_full.rds")
sum_bat <- stan_summary(data_bat_full, bat_full, ml_bat_full)
stan_shrinkage_plots(sum_bat)

data_bird_full <- readRDS("../Results/stan/Model_data_birds_all_full.rds")
bird_full <- readRDS("../Results/stan/stan6_birds_all_full.rds")
ml_bird_full <- readRDS("../Results/stan/ML_birds_all_full.rds")
sum_bird <- stan_summary(data_bird_full, bird_full, ml_bird_full)
stan_shrinkage_plots(sum_bird, ann = c("C", "D"))

```

__Extended Data Fig. 5__ Model shrinkage. Shrinkage behavior of theta estimates for the full models for (A-B) bats and (C-D) birds. Y axes represent deviations of maximum likelihood estimates of spatial association, $\hat{\theta_i}$, which are calculated separately for each occupancy set (see Fig. 2), from Bayesian estimates, $\theta_i$, which involve data pooling (Eq. 3). Maximum likelihood estimates will be $\pm \infty$ whenever all of the co-occurrence observations in the set take the minimum values (i.e. $N_{AB}=\text{max}(0,N_B-N_{(A)})$, 
`r (100*length(which(sum_bat$diff_ml == -4))/nrow(sum_bat)) %>% round(2)`% and 
`r (100*length(which(sum_bird$diff_ml == -4))/nrow(sum_bird)) %>% round(2)`% of occupancy sets for bats and birds, respectively) or maximum values (i.e. $N_{AB}=\text{min}(N_A,N_B)$, 
`r (100*length(which(sum_bat$diff_ml == 4))/nrow(sum_bat)) %>% round(2)`% and 
`r  (100*length(which(sum_bird$diff_ml == -4))/nrow(sum_bird)) %>% round(2)`% of sets for bats and birds, respectively). 

```{r edf5, echo = FALSE, include = TRUE, fig.height=4, fig.width = 8, dpi = 200}
batdist <- ggplot(sum_bat, aes(x =theta_bayes)) + 
  geom_histogram(bins = 12) + 
  facet_wrap(~group) + labs(x = expression(theta[i]))

birddist <- ggplot(sum_bird, aes(x =theta_bayes)) + 
  geom_histogram(bins = 12) + 
  facet_wrap(~group) + labs(x = expression(theta[i]))

plot_grid(batdist, birddist, labels = c("A", "B"), ncol = 2)

```

__Extended Data Fig. 6__ Distribution of $\theta_i$ values. There is one $\theta$ value for each occupancy set for each experimental group in the bat model (A) and the bird model (B). 


```{r edf6, echo = FALSE, include = TRUE, fig.height=4, fig.width = 8, dpi = 200}
A <- ggplot(sum_bat, aes(x = s1, y = theta_bayes)) + 
  geom_point(size = .5, alpha = .5) + facet_wrap(~group) + 
  geom_smooth(formula = y ~ x, method = "loess", fill = NA) + 
  geom_line(aes(y = 0), lty = 2) + 
  labs(x = "occupancy of rarer species in set", y = expression(spatial~association~theta[i]))

B <- ggplot(sum_bat, aes(x = log_n, y = theta_bayes)) + 
  geom_point(size = .5, alpha = .5) + facet_wrap(~group) + 
  geom_smooth(formula = y ~ x, method = "loess", fill = NA) + 
  geom_line(aes(y = 0), lty = 2) + 
  labs(x = "log(number of pairs)", y = expression(spatial~association~theta[i]))

plot_grid(A, B, labels = c("A", "B"))

```

__Extended Data Fig. 7__ Bayesian estimates of spatial association, $\theta_i$, for bats plotted against: (A) the occupancy of the rarer species in the occupancy set, and (B), the number of pairs in the occupancy set. Each point represents an estimate for an occupancy set (see Fig. 2). Lowess curves (blue lines) are included for visualization only.


```{r edf7, echo = FALSE, include = TRUE, fig.height=4, fig.width = 8, dpi = 200}
A <- ggplot(sum_bird, aes(x = s1, y = theta_bayes)) + 
  geom_point(size = .5, alpha = .5) + facet_wrap(~group) + 
  geom_smooth(formula = y ~ x, method = "loess", fill = NA) + 
  geom_line(aes(y = 0), lty = 2) + 
  labs(x = "occupancy of rarer species in set", y = expression(spatial~association~theta[i]))

B <- ggplot(sum_bird, aes(x = log_n, y = theta_bayes)) + 
  geom_point(size = .5, alpha = .5) + facet_wrap(~group) + 
  geom_smooth(formula = y ~ x, method = "loess", fill = NA) + 
  geom_line(aes(y = 0), lty = 2) + 
  labs(x = "log(number of pairs)", y = expression(spatial~association~theta[i]))

plot_grid(A, B, labels = c("A", "B"))

```

__Extended Data Fig. 8__ Bayesian estimates of spatial association, $\theta_i$, for birds plotted against: (A) the occupancy of the rarer species in the occupancy set, and (B), the number of pairs in the occupancy set. Each point represents an estimate for an occupancy set (see Fig. 2). Lowess curves (blue lines) are included for visualization only.

__Extended Data Table 1.__
Results of richness analyses comparing estimated richness in altered and intact habitats using three metrics. Table includes median metric output across sites and results of Wilcoxon rank-sum tests comparing intact and altered richnesses. Key: chao= Chao 1, cJ1 = second-order jaccknife, fa = Fisher's Alpha, p = p value of Wilcoxon Rank Sum test, W = test statistic of Wilcoxon Rank Sum test. 

```{r echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
rsumm %>% select(-`mean richness`) %>% pivot_wider(names_from = "status", values_from = `median richness`) %>% full_join(rsig, by = c("taxon", "metric")) %>% 
  mutate(Altered = round(Altered, 1), Intact = round(Intact, 1), p = round(p, 3)) %>% 
  flextable()
```


__Extended Data Table 2.__
Results of beta diversity and composition analyses comparing community patterns in altered and intact habitats. F-statistic and _p_-values are displayed for bats and birds.

```{r echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
output %>% arrange(analysis) %>% mutate(across(where(is.numeric), round, digits = 4)) %>% flextable()
```


__Extended Data Table 3.__ 
Median values and 95% high density posterior intervals for $\overline{\theta_{g}}$ and $\sigma_{g}$ of all bat and bird models.
```{r echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

l <- list.files('../Results/stan', full.names = TRUE, pattern = "stan6")

res <- map(l, ~readRDS(.x) %>% format_stanfit("mu")) %>%
  setNames(c(paste(ifelse(grepl("bat",l, fixed = TRUE), "bat", "bird"),
                   ifelse(grepl("shared", l, fixed = TRUE), "noTurnover", "full")) %>% trimws() %>% str_replace_all(" ", "_"))) %>% 
  bind_rows(.id = "model")

res2 <- map(l, ~readRDS(.x) %>% format_stanfit("sigma")) %>%
  setNames(c(paste(ifelse(grepl("bat",l, fixed = TRUE), "bat", "bird"),
                   ifelse(grepl("shared", l, fixed = TRUE), "noTurnover", "full")) %>% trimws() %>% str_replace_all(" ", "_"))) %>% 
  bind_rows(.id = "model")

res$sigma <- res2$sigma

hdpi95 <- res %>% group_by(model, group) %>% 
  summarise(`Median θ` = median(mu), `Lower θ` = hdi(mu, 0.95)$CI_low, `Upper θ` = hdi(mu, 0.95)$CI_high, `Median σ` = median(sigma), `Lower σ` = hdi(sigma, 0.95)$CI_low, `Upper σ` = hdi(sigma, 0.95)$CI_high) %>% mutate(across(where(is.numeric), round, digits = 4)) %>%
  separate(group, into = c("status", "Pair_type")) %>%
  separate(model, into = c("taxon", "model"), extra = "merge") 
  
flextable(hdpi95)

```


### Supplementary Information

#### Supplementary Methods

_Data_

Abundance data were downloaded from the Ecological Register (http://ecoregister.org) on 7 June 2020 for mist-netted bats and birds from the Neotropics, defined as all areas in the western hemisphere south of the Tropic of Cancer (23.44˚N). We also downloaded Register metadata for the species and sites in the abundance data, including coordinates and habitat alteration categories for sites and dietary guild assignments for species. Guild assignments were based on a large set of recently published papers. These categorisations are based on primary literature, with the most recently published and detailed assignments being drawn automatically from the database by the website's downloading routine. The status of each site is based on the ‘altered.habitat’ field in the site metadata, which is empty if the site is intact and filled with a land use category if the site is altered. Altered sites included cropland, disturbed forest, fragment, pasture, plantation, secondary forest, inhabited area, and combined categories [@Alroy2017], and none of them had sufficient sites to be evaluated individually. 

The Ecological Register provides methodologically consistent abundance data. Thus, sampling and reporting were standardised across the samples: all were mist-netted samples with consistent mesh size, harp net samples were excluded, and almost all nets were placed at ground level. Every sample consisted of a minimum of 20 individuals, and most sites had more than 50, with the median number of individuals per sample being `r norig.bat.samp` for bats and `r norig.bird.samp` for birds.  Samples were combined if they were less than 1 km from one another, sourced from the same study, and represented the same habitat and alteration category. The combined data set consisted of `r norig.bat.indi` bat and `r norig.bird.indi` bird individuals constituting `r norig.bat.occur` bat and `r norig.bird.occur` bird records from `r norig.bat.sites` and `r norig.bird.sites` sites, respectively. 

The geographic layout of sites can influence the results of any community ecology analysis, including co-occurrence analysis. For instance, if sites are clustered in two regions with no sites in between, there is a possibility that the co-occurrence structure of the assemblage will reflect this clustered layout by creating strong aggregations within the clusters and segregations between clusters. Ideally, we would like to have even sampling over our entire study area, but when this is not possible, we must at least make sure that any comparisons are not influenced by geographic sampling bias. One way to achieve this is to ensure that the sites used to calculate co-occurrences have roughly the same geographic coverage when comparing different types of sites.

In this paper, the study extent covers Central and South America south of the Tropic of Cancer. This includes large swathes of the Brazilian Amazon, where there are no samples in altered habitats. As a result, the intact sites cover more area than the altered sites, and the geographic coverage of the latter is nested within that of the former. To correct for these biases before calculating co-occurrences, we removed the intact sites covering areas that were not covered by altered sites using the following algorithm: (1) we measured the distance to the closest altered site for all intact sites and vice versa; (2) we found the altered site farthest from its closest intact site; (3) we removed all intact sites whose closest altered neighbors were farther than the distance in step 2. Note that this approach only works because the geographic coverages are nested; site types that are offset in space would require a different approach. The resulting dataset had `r sum(tobinary.single(PAn[["bat"]]))` occurrences of bats and `r sum(tobinary.single(PAn[["bird"]]))` occurrences of birds at `r ncol(PAn[["bat"]])` and `r ncol(PAn[["bird"]])` sites, respectively. Our original and final sites are plotted in Extended Data Fig. 1.

_Performance of the NHD parameter_

To demonstrate the behaviour of the NHD, we calculate how the distribution of $N_{AB}$ (the number of sites in which co-occurrence is observed) values varies when the underlying association ranges from strong repulsion to strong attraction (i.e., $\theta$ ranging from -2 to 2). For these simulations, we used occurrence values that span most species in our datasets ($N_{A}$ and $N_{B}$ ranging from 2 to 8; Extended Data Figure 3). The total number of sites was set at 50, which is similar to the values for the bird and bat datasets we analysed. Aside from demonstrating that increases in $\theta$ correspond to higher probabilities of more frequent co-occurrences, as we would expect from a reliable metric, two noteworthy observations arise from these calculations. First, if occurrences of the two species are low relative to the total number of sites ($N_{A}=N_{B}=2$), $N_{AB}=0$ is the most likely outcome even when $\theta=2$, which corresponds to over 7-fold higher odds of species B occurring at a site if species A
is present (solid red line in Extended Data Figure 3). Second, as the numbers of sites
occupied by the two species increases, the distribution of $N_{AB}$ values exhibits
a greater shift in mode with changes in $\theta$: when $N_{A}=N_{B}=2$, the mode
for $N_{AB}$ remains at 0 for all three $\theta$ values (-2, 0, 2), whereas when
$N_{A}=N_{B}=8$, the mode shifts from 0 (at $\theta=-2$) to 4 (at $\theta=2$).

To understand how maximum likelihood of the NHD behaves in relation to $\theta$, we take logarithms of both sides of Eq. 1a, and differentiate with respect to $\theta$, yielding an expression
for what is known as the _score_:

\[
\frac {\partial \log f(N_{AB}\mid\theta)}{\partial\theta} = 
N_{AB} - P_1(\theta)/P_0(\theta)
\]

where $P_1(\theta)/P_0(\theta)$ (see Eq. 1b) is the average number of co-occurrences for the NHD [@McCullagh1952]. Given that the maximum likelihood for $\theta$, $\hat{\theta}$, is achieved when $\partial \log f(N_{AB} \mid \theta) / \partial \theta = 0$, Eq. S1 implies that $\hat{\theta}$ corresponds to the NHD with a mean equal to the observed number of co-occurrences, $N_{AB}$. (While there is no exact analytical expression for this mean, accurate approximations have been derived [@Eisinga2011].) Because the mean of the distribution cannot be equal to its minimum or maximum value if there is more than one possible number of co-occurrences, the estimate of $\hat{\theta}$ inferred from a single observation is biologically uninformative whenever the observed number of co-occurring sites $N_{AB}$ is equal to the minimum or maximum possible values. For example, when one species is only found where the other is present (i.e., $\hat{\theta}=\infty$ if $N_{AB}=\min(N_{A},N_{B})$) or when a pair has no co-occurrences (i.e., $\hat{\theta}=-\infty$ if $N_{AB}=\max(0,N_{B}-N_{(A)})$). While this behaviour is desirable because it means that $\theta$ accurately represents co-occurrence configurations that cannot statistically provide biological information, it highlights an overarching difficulty of traditional co-occurrence analysis: namely, that such edge cases are extremely common in most empirical datasets. 

These analyses bring to the forefront a key question: how reliably can we estimate species association using occurrence data alone? Our capacity to infer $\theta$ from observations is fundamentally constrained by the Fisher Information, which is the variance of the score [@Ly2017]. We
can characterise how the Fisher information varies with $\theta$,
$I(\theta)$, by combining Eqs. 1 and S1:

\[
I(\theta) = E \left[ \left( \frac {\partial \log f(N_{AB}\mid\theta)}{\partial\theta} \right)^2 \mid \theta \right] = 
\sum^{min(N_{A}, N_{B})} _{n = max(0, N_{B}-N_{(A)})} {f(n \mid \theta)} \left (\frac {\partial \log f(N_{AB}\mid\theta)}{\partial\theta} \right)^2 =
\frac {P_2(\theta)}{P_0(\theta)} - \left(\frac {P_1(\theta)}{P_0(\theta)}\right)^2
\]


Remarkably, Eq. S2 demonstrates that, when the NHD is parameterised using
$\theta$, the Fisher Information is
$P_2(\theta)/P_0(\theta)-(P_1(\theta)/P_0(\theta))^2$, which is also the
variance of the NHD [@McCullagh1952].
Parameterizing the NHD using the odds ratio $\psi$ would yield a different
expression for the Fisher Information.

Calculations performed using Eq. S2 demonstrate that the Fisher Information
generally increases with the species occurrences $N_{A}$ and $N_{B}$ (Extended Data Figure 4).
Loosely speaking, this result indicates that the distribution of co-occurrence
values, $N_{AB}$, changes more rapidly with changes in $\theta$ for species
pairs with greater numbers of occurrences, consistent with Extended Data Figure 3. Thus,
$\theta$ can be estimated more efficiently from species pairs with more
occurrences. Importantly, however, Fisher Information eventually declines as the
numbers of occurrences for the two species approach the total number of sites (note
the depressed yellow curve for $N_{A} = N_{B} = 40$ in Extended Data Figure 4). This decline
occurs due to an increasing lower bound on the minimum number of co-occurrences
($=\max(0,N_{B}-N_{(A)}$). Also notably, the Fisher Information eventually
approaches 0 for very low and very high values of $\theta$, regardless of
$N_{A}$ and $N_{B}$, because the distributions of $N_{AB}$ values eventually
become concentrated on this lower bound as $\theta$ declines, and on the upper
bound $\min(N_{A},N_{B})$ as $\theta$ increases.

_Model robustness checks_

We ran a series of checks to test that our Bayesian model is robust and not subject to common biases. First, we estimated the shrinkage present in our model results by comparing the bayesian model output to the same model calculated using maximum likelihood. Shrinkage refers to the tendency of observations with less information to gravitate toward the group mean in hierachical models. We want to see relatively little shrinkage in most sets, but more in occupancy sets with fewer pairs. We also want to see increased shrinkage in sets that fall farther from the group mean. These properties were observed for both bats and birds (Extended Data Fig. 5). 

We also examined our model output for near-normal distributions and common biases. We plotted $\theta_g$ estimates of each occupancy pair set against the number of pairs in the set and against the occupancy of the rarer species in the set. There were no consistent trends across the four experimental groups for either taxon, indicating that $\theta_g$ does not suffer from bias due to these factors (Extended Data Figs 6-8). 


Supplementary References: 

